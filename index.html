<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Badminton Queue Manager</title>
    <style>
        /* CSS Custom Properties for Apple-like Design System */
        :root {
            /* Colors */
            --primary: #007AFF;
            --secondary: #5856D6;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
            --gray-1: #8E8E93;
            --gray-2: #C7C7CC;
            --gray-3: #E5E5EA;
            --gray-4: #F2F2F7;
            --background: #FFFFFF;
            
            /* Typography */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            
            /* Spacing */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            
            /* Border Radius */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.05);
            --warning-light: rgba(255, 149, 0, 0.1);
        }

        /* Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--gray-4);
            color: #000;
            line-height: 1.5;
        }

        /* Layout */
        .app {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            background: var(--background);
            border-right: 1px solid var(--gray-3);
            padding: 0; /* Remove padding to have header stick to top */
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .sidebar-header {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--gray-3);
            background: var(--background);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .sidebar-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .search-box {
            position: relative;
            margin-bottom: var(--spacing-sm);
        }

        .search-box input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            padding-left: 32px; /* Space for icon */
            border: 1px solid var(--gray-3);
            border-radius: var(--radius-md);
            font-size: 16px; /* Minimum font size to prevent zoom on iOS */
            -webkit-text-size-adjust: 100%; /* Prevent text size adjust on orientation change */
            touch-action: manipulation; /* Prevent double-tap zoom */
        }

        .search-box::before {
            content: "üîç";
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-1);
            font-size: 14px;
        }

        .players-list {
            padding: var(--spacing-md);
            overflow-y: auto;
            flex: 1;
        }

        .player-card {
            display: flex;
            align-items: center;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            background: var(--background);
            border: 1px solid var(--gray-3);
            transition: all 0.2s ease;
        }

        .player-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
            border-color: var(--gray-2);
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: var(--spacing-xs);
            color: #000;
        }

        .player-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
        }

        /* Update the status chip styles */
        .status-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            height: 20px;
            transition: all 0.2s ease;
        }

        .status-chip.waiting {
            background: var(--gray-3);
            color: var(--gray-1);
        }

        .status-chip.playing {
            background: #FFF4E5;  /* Light yellow background */
            color: var(--warning);  /* Warning/yellow color for text */
            border: 1px solid var(--warning);  /* Yellow border */
            animation: pulse 2s infinite;  /* Keep the animation */
        }

        .status-chip.queued {
            background: var(--warning);
            color: white;
        }

        .status-chip.resting {
            background: #E9ECFE;  /* Light purple background */
            color: var(--secondary);  /* Keep the secondary color for text */
            border: 1px solid var(--secondary);  /* Add border for better definition */
        }

        .status-chip.ready {
            background: #ECFDF3;  /* Light green background */
            color: var(--success);  /* Success green color for text */
            border: 1px solid var(--success);  /* Green border */
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .skill-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            background: var(--gray-4);
            color: var(--gray-1);
            font-size: 12px;
            font-weight: 600;
            padding: 0 6px;
        }

        /* Update the games-badge style */
        .games-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            background: #EEF2FF;  /* Light indigo background */
            color: #4F46E5;  /* Indigo text color */
            border: 1px solid #4F46E5;  /* Indigo border */
            font-size: 12px;
            font-weight: 600;
            height: 20px;
        }

        .player-actions {
            display: flex;
            gap: var(--spacing-xs);
            margin-left: var(--spacing-md);
        }

        .player-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 14px;
            border: 1px solid var(--gray-3);
            background: var(--background);
            color: var(--gray-1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .player-action-btn:hover {
            background: var(--gray-4);
            color: var(--primary);
            border-color: var(--primary);
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-xl) var(--spacing-md);
            color: var(--gray-1);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: var(--spacing-md);
            color: var(--gray-2);
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            min-height: 0;  /* Important for sticky header */
            flex: 1;
        }

        /* Components */
        .button {
            background: var(--primary);
            color: white;
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .button:hover {
            opacity: 0.9;
        }

        .button.secondary {
            background: var(--gray-3);
            color: #000;
        }

        .card {
            background: var(--background);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--spacing-md);
        }

        /* Mobile Responsive */
        @media (max-width: 800px) {
            .app {
                grid-template-columns: 1fr;
            }

            .sidebar {
                display: none;
            }

            .sidebar.active {
                display: block;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 1000;
            }
        }

        /* Additional Component Styles */
        .tab-bar {
            display: flex;
            gap: var(--spacing-sm);
            padding: var(--spacing-md);
            background: var(--background);
            border-bottom: 1px solid var(--gray-3);
        }

        .tab-button {
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            background: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            color: var(--gray-1);
        }

        .tab-button.active {
            background: var(--gray-4);
            color: var(--primary);
        }

        .court-card {
            background: var(--background);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--spacing-lg);
            overflow: hidden;
            border: 1px solid var(--gray-3);
        }

        .court-header {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--gray-3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--gray-4);
        }

        .court-title {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .court-name {
            font-weight: 600;
            font-size: 18px;
        }

        .court-status {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--success);
            color: white;
        }

        .court-actions {
            display: flex;
            gap: var(--spacing-xs);
        }

        .button.small {
            padding: 4px 8px;
            font-size: 12px;
        }

        .button.danger {
            background: var(--danger);
            color: white;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .game-timer {
            font-size: 24px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            color: var(--gray-1);
            transition: color 0.3s ease;
            padding: 4px 12px;
            border-radius: var(--radius-md);
        }

        .game-timer.long-game {
            color: var(--warning);
            background: var(--warning-light);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .teams-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: var(--spacing-md);
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .team {
            background: var(--gray-4);
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-3);
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .team-players {
            display: grid;
            gap: var(--spacing-xs);
        }

        .empty-slot {
            background: var(--background);
            border: 1px dashed var(--gray-2);
            border-radius: var(--radius-sm);
            padding: var(--spacing-sm);
            text-align: center;
            color: var(--gray-1);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .empty-slot:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .vs-badge {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-3);
            border-radius: 20px;
            font-weight: 600;
            color: var(--gray-1);
        }

        .button-icon {
            width: 24px;
            height: 24px;
            border-radius: 12px;
            border: 1px solid var(--gray-3);
            background: var(--background);
            color: var(--gray-1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s ease;
        }

        .button-icon:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .game-section, .queue-section {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--gray-3);
        }

        .game-actions {
            display: flex;
            justify-content: center;
            margin-top: var(--spacing-md);
        }

        .empty-state.small {
            padding: var(--spacing-md);
            font-size: 14px;
        }

        @media (max-width: 800px) {
            .teams-container {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
            }

            .vs-badge {
                margin: var(--spacing-xs) auto;
            }
        }

        .dialog {
            border: none;
            border-radius: var(--radius-lg);
            padding: 0;
            box-shadow: var(--shadow-lg);
            max-width: 90vw;
            width: 500px;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            margin: 0;
        }

        .dialog::backdrop {
            background: rgba(0, 0, 0, 0.3);
        }

        .dialog-header {
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--gray-3);
        }

        .dialog-content {
            padding: var(--spacing-md);
        }

        .dialog-actions {
            padding: var(--spacing-md);
            border-top: 1px solid var(--gray-3);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
        }

        /* Update the mobile-menu-button styles */
        .mobile-menu-button {
            display: none;
            position: fixed;
            bottom: var(--spacing-md);
            right: var(--spacing-md);
            padding: var(--spacing-sm) var(--spacing-md);
            min-width: 140px;
            height: 48px;
            border-radius: 24px;
            background: var(--primary);
            color: white;
            border: none;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .mobile-menu-button:active {
            transform: scale(0.98);
        }

        .mobile-menu-button:hover {
            box-shadow: var(--shadow-xl);
        }

        @media (min-width: 801px) {
            .mobile-menu-button {
                display: none;
            }
        }

        /* Add these styles for the sidebar overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Update sidebar styles for mobile */
        @media (max-width: 800px) {
            .sidebar {
                position: fixed;
                top: 0;
                right: -300px; /* Start off-screen */
                bottom: 0;
                width: 300px;
                transition: right 0.3s ease;
                z-index: 1000;
            }

            .sidebar.active {
                right: 0;
            }
        }

        /* Dialog Improvements */
        .dialog-tabs {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            padding-bottom: var(--spacing-sm);
            border-bottom: 1px solid var(--gray-3);
        }

        .dialog-tab {
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            background: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            color: var(--gray-1);
        }

        .dialog-tab.active {
            background: var(--gray-4);
            color: var(--primary);
        }

        .dialog-tab-content {
            display: block;
        }

        .dialog-tab-content.hidden {
            display: none;
        }

        .form-group {
            margin-bottom: var(--spacing-md);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-xs);
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: var(--spacing-sm);
            border: 1px solid var(--gray-3);
            border-radius: var(--radius-md);
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-help {
            font-size: 12px;
            color: var(--gray-1);
            margin-top: var(--spacing-xs);
        }

        .bulk-import-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
        }

        .bulk-import-preview {
            border: 1px solid var(--gray-3);
            border-radius: var(--radius-md);
            background: var(--gray-4);
        }

        .preview-header {
            padding: var(--spacing-sm) var(--spacing-md);
            border-bottom: 1px solid var(--gray-3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: var(--gray-1);
        }

        .preview-list {
            padding: var(--spacing-sm);
            max-height: 176px; /* Same as textarea (8 rows) */
            overflow-y: auto;
        }

        .preview-item {
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--radius-sm);
            margin-bottom: 2px;
            font-size: 14px;
        }

        .preview-item:hover {
            background: var(--gray-3);
        }

        .preview-item.invalid {
            color: var(--danger);
        }

        @media (max-width: 800px) {
            .bulk-import-container {
                grid-template-columns: 1fr;
            }
        }

        .main-header {
            position: sticky;
            top: 0;
            background: var(--background);
            border-bottom: 1px solid var(--gray-3);
            z-index: 10;
            padding: var(--spacing-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .main-header-actions {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
        }

        .main-header-title {
            font-size: 24px;
            font-weight: 600;
            color: #000;
        }

        .tab-bar {
            display: inline-flex;
            gap: var(--spacing-xs);
            padding: 4px;
            background: var(--gray-4);
            border-radius: var(--radius-lg);
        }

        .tab-button {
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            background: none;
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            color: var(--gray-1);
            min-width: 100px;
            transition: all 0.2s ease;
        }

        .tab-button.active {
            background: var(--background);
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .tab-button:hover:not(.active) {
            color: var(--primary);
        }

        .courts-container, .queues-container {
            padding: var(--spacing-md);
        }

        .hidden {
            display: none;
        }

        @media (max-width: 800px) {
            .main-header {
                flex-direction: column;
                padding: var(--spacing-sm);
                gap: var(--spacing-sm);
            }

            .main-header-actions {
                width: 100%;
                justify-content: space-between;
            }

            .courts-container {
                padding: var(--spacing-sm);
                grid-template-columns: 1fr;
            }

            .tab-bar {
                width: 100%;
                display: grid;
                grid-template-columns: 1fr 1fr;
            }
        }

        .queues-header {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .queues-header .search-box {
            flex: 1;
            margin: 0;
        }

        .queue-card {
            background: var(--background);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-3);
            margin-bottom: var(--spacing-md);
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .queue-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .queue-header {
            padding: var(--spacing-md);
            background: var(--gray-4);
            border-bottom: 1px solid var(--gray-3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .queue-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .queue-number {
            font-weight: 600;
            font-size: 16px;
        }

        .queue-status {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            background: var(--warning);
            color: white;
        }

        .queue-actions {
            display: flex;
            gap: var(--spacing-xs);
        }

        .queue-teams {
            padding: var(--spacing-md);
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: var(--spacing-md);
            align-items: center;
        }

        .queue-team h4 {
            margin-bottom: var(--spacing-sm);
            color: var(--gray-1);
        }

        .queue-players {
            display: grid;
            gap: var(--spacing-xs);
        }

        .player-chip {
            background: var(--background);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            border: 1px solid var(--gray-3);
            transition: all 0.2s ease;
        }

        .player-chip:hover {
            border-color: var(--gray-2);
            box-shadow: var(--shadow-sm);
        }

        .player-chip-content {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .player-chip-name {
            font-weight: 500;
        }

        .player-chip-actions {
            display: flex;
            gap: 4px;
        }

        .chip-action {
            width: 24px;
            height: 24px;
            border-radius: 12px;
            border: 1px solid var(--gray-3);
            background: var(--background);
            color: var(--gray-1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s ease;
            padding: 0;
        }

        .chip-action:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .button-icon[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .empty-player {
            background: var(--background);
            border: 1px dashed var(--gray-2);
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            text-align: center;
            color: var(--gray-1);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .empty-player:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .vs-label {
            font-weight: 500;
            color: var(--gray-1);
            text-align: center;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 800px) {
            .queues-header {
                flex-direction: column;
            }

            .queue-teams {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
            }

            .vs-label {
                margin: var(--spacing-sm) 0;
            }
        }

        .players-grid {
            display: grid;
            gap: var(--spacing-sm);
            margin: var(--spacing-md) 0;
            max-height: 400px;
            overflow-y: auto;
            padding: var(--spacing-xs);
        }

        .player-selection-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            background: var(--gray-4);
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .player-selection-item:hover {
            background: var(--gray-3);
        }

        .player-selection-item.selected {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .player-selection-item.unavailable {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--gray-3);
        }

        .player-selection-item .player-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .player-selection-item .player-statuses {
            display: flex;
            gap: var(--spacing-xs);
        }

        .player-selection-item .player-name {
            font-weight: 600;
            color: #000;
            margin-right: var(--spacing-sm);
        }

        .player-selection-item.selected .status-chip {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .player-selection-item .skill-badge {
            background: var(--background);
            border: 1px solid var(--gray-3);
            color: var(--gray-1);
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .player-selection-item.selected .skill-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
        }

        #playerSelectionDialog .search-box {
            margin: var(--spacing-md) 0;
        }

        /* Add these styles */
        .queue-items {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .queue-item {
            background: var(--background);
            border: 1px solid var(--gray-3);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
        }

        .queue-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .queue-number {
            font-weight: 500;
            color: var(--gray-1);
        }

        .queue-teams {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: var(--spacing-sm);
            align-items: center;
            margin-top: var(--spacing-sm);
        }

        .queue-team {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .vs-label {
            color: var(--gray-1);
            font-weight: 500;
        }

        .player-chip.small {
            padding: var(--spacing-xs) var(--spacing-sm);
            font-size: 12px;
        }

        .queue-item {
            background: var(--background);
            border: 1px solid var(--gray-3);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }

        .queue-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .queue-number {
            font-weight: 500;
            color: var(--gray-1);
        }

        .queue-actions {
            display: flex;
            gap: 4px;
        }

        .queue-preview {
            margin-top: var(--spacing-md);
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--gray-3);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm);
            background: var(--gray-4);
        }

        .queue-preview .queue-item {
            margin-bottom: var(--spacing-sm);
            background: var(--background);
        }

        .queue-preview .queue-item:last-child {
            margin-bottom: 0;
        }

        .dialog-content .section-header {
            margin-top: var(--spacing-lg);
        }

        /* Add/Update these styles */
        .dialog .game-section,
        .dialog .queue-section {
            padding: var(--spacing-md);
            background: var(--gray-4);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-md);
            border: 1px solid var(--gray-3);
        }

        .dialog .team {
            background: var(--background);
        }

        .dialog .queue-preview {
            margin-top: 0;
            background: var(--background);
            max-height: 200px;
            overflow-y: auto;
        }

        .dialog .queue-preview .queue-item {
            margin: var(--spacing-sm);
        }

        .dialog .queue-preview .queue-item:last-child {
            margin-bottom: var(--spacing-sm);
        }

        .dialog .player-chip {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--background);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-xs);
            border: 1px solid var(--gray-3);
        }

        .dialog .player-chip:hover {
            border-color: var(--gray-2);
            box-shadow: var(--shadow-sm);
        }

        .dialog .empty-slot {
            background: var(--background);
            border: 1px dashed var(--gray-2);
            padding: var(--spacing-sm);
            text-align: center;
            color: var(--gray-1);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: var(--spacing-xs);
        }

        .dialog .empty-slot:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .new-queue-match {
            background: var(--gray-4);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-md);
            border: 1px solid var(--gray-3);
        }

        .new-queue-match .teams-container {
            margin-bottom: var(--spacing-md);
        }

        .queue-actions {
            display: flex;
            justify-content: center;
        }

        .queue-list h4 {
            margin-bottom: var(--spacing-md);
            color: var(--gray-1);
        }

        /* Update/Add these styles */
        .queue-teams {
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
            background: var(--gray-4);
            border-radius: var(--radius-md);
        }

        .queued-matches {
            margin-top: var(--spacing-md);
        }

        .queue-item {
            padding: var(--spacing-sm);
            border-radius: var(--radius-md);
            background: var(--gray-4);
            margin-bottom: var(--spacing-xs);
        }

        .queue-teams {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: var(--spacing-sm);
            align-items: center;
        }

        .queue-team {
            font-size: 14px;
            text-align: center;
        }

        .vs-text {
            color: var(--gray-1);
            font-size: 12px;
        }

        .player-name {
            font-weight: 500;
        }

        .queue-matches {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .queue-teams {
            position: relative;
            padding: var(--spacing-sm);
            background: var(--gray-4);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-xs);
        }

        .remove-queue-team {
            position: absolute;
            top: var(--spacing-xs);
            right: var(--spacing-xs);
            width: 20px;
            height: 20px;
            border-radius: 10px;
            border: 1px solid var(--gray-3);
            background: var(--background);
            color: var(--gray-1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            padding: 0;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .queue-teams:hover .remove-queue-team {
            opacity: 1;
        }

        .remove-queue-team:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .add-queue-team {
            padding: var(--spacing-sm);
            border: 1px dashed var(--gray-3);
            border-radius: var(--radius-md);
            background: none;
            color: var(--gray-1);
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .add-queue-team:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .queued-matches h4 {
            margin: var(--spacing-md) 0 var(--spacing-sm);
            color: var(--gray-1);
            font-size: 14px;
        }

        /* Add to the existing styles section */
        .unified-queue-section {
            background: var(--background);
            border-radius: var(--radius-lg);
            border: 1px solid var(--gray-3);
            padding: var(--spacing-md);
            position: sticky;
            top: var(--spacing-md);
            max-height: calc(100vh - 2 * var(--spacing-md));
            overflow-y: auto;
        }

        .building-match {
            margin-bottom: var(--spacing-lg);
            padding: var(--spacing-md);
            background: var(--gray-4);
            border-radius: var(--radius-md);
        }

        .queue-entries {
            padding: var(--spacing-md);
            display: grid;
            gap: var(--spacing-md);
        }

        .queue-entry {
            background: var(--background);
            border: 1px solid var(--gray-3);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            cursor: move;
            transition: all 0.2s ease;
        }

        .queue-entry:hover {
            border-color: var(--gray-2);
            box-shadow: var(--shadow-sm);
        }

        .queue-entry.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }

        .queue-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .waiting-time {
            font-variant-numeric: tabular-nums;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .queue-recent .waiting-time {
            background: var(--success);
            color: white;
        }

        .queue-waiting .waiting-time {
            background: var(--warning);
            color: white;
        }

        .queue-long-wait .waiting-time {
            background: var(--danger);
            color: white;
        }

        .queue-section {
            background: var(--gray-4);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .queued-matches {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .queued-matches h4 {
            color: var(--gray-1);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: var(--spacing-sm);
        }

        .queue-item {
            background: var(--background);
            border: 1px solid var(--gray-3);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            transition: all 0.2s ease;
        }

        .queue-item:hover {
            border-color: var(--gray-2);
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .queue-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-md);
        }

        .queue-number {
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-1);
            background: var(--gray-4);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
        }

        .queue-teams {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: var(--spacing-md);
            align-items: center;
        }

        .queue-team {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .queue-team .player-name {
            background: var(--gray-4);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--radius-md);
            font-weight: 500;
            text-align: center;
        }

        .queue-team .player-name:not(:last-child) {
            margin-bottom: var(--spacing-xs);
        }

        .vs-text {
            font-weight: 500;
            color: var(--gray-1);
            background: var(--gray-4);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
        }

        .queue-actions {
            display: flex;
            gap: var(--spacing-xs);
        }

        .queue-action-btn {
            width: 28px;
            height: 28px;
            border-radius: 14px;
            border: 1px solid var(--gray-3);
            background: var(--background);
            color: var(--gray-1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .queue-action-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .queue-action-btn.remove:hover {
            background: var(--danger);
            border-color: var(--danger);
        }

        @media (max-width: 640px) {
            .queue-teams {
                grid-template-columns: 1fr;
                gap: var(--spacing-sm);
            }

            .vs-text {
                margin: var(--spacing-xs) auto;
            }
        }

        .queue-builder {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: var(--spacing-md);
            align-items: center;
            margin: var(--spacing-md) 0;
            padding: var(--spacing-md);
            background: var(--gray-4);
            border-radius: var(--radius-md);
        }

        .queue-match {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            background: var(--background);
            border: 1px solid var(--gray-3);
            border-radius: var(--radius-md);
            margin-bottom: var(--spacing-sm);
            cursor: move;
        }

        .queue-match-teams {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: var(--spacing-sm);
            align-items: center;
        }

        .remove-match {
            border: none;
            background: none;
            color: var(--gray-1);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: 50%;
        }

        .remove-match:hover {
            background: var(--gray-4);
            color: var(--danger);
        }

        /* Add these styles after the existing .queued-matches styles */
        .queued-matches {
            margin-top: var(--spacing-lg);
            border-top: 1px solid var(--gray-3);
            padding-top: var(--spacing-md);
        }

        .queued-matches h4 {
            color: var(--gray-1);
            margin-bottom: var(--spacing-md);
            font-size: 14px;
        }

        .queue-item {
            background: var(--background);
            border: 1px solid var(--gray-3);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            margin-bottom: var(--spacing-sm);
            transition: all 0.2s ease;
        }

        .queue-item:hover {
            border-color: var(--gray-2);
            box-shadow: var(--shadow-sm);
            transform: translateY(-1px);
        }

        .queue-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .queue-number {
            font-weight: 500;
            color: var(--gray-1);
            font-size: 14px;
            padding: 2px 8px;
            background: var(--gray-4);
            border-radius: var(--radius-sm);
        }

        .queue-teams {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: var(--spacing-md);
            align-items: center;
            padding: var(--spacing-sm);
        }

        .queue-team {
            background: var(--gray-4);
            padding: var(--spacing-sm);
            border-radius: var(--radius-sm);
            text-align: center;
        }

        .queue-team .player-name {
            font-weight: 500;
            color: var(--primary);
            display: inline-block;
            margin: 0 var(--spacing-xs);
        }

        .queue-team .player-name:not(:last-child)::after {
            content: "&";
            color: var(--gray-1);
            margin-left: var(--spacing-xs);
        }

        .vs-text {
            color: var(--gray-1);
            font-weight: 500;
            font-size: 12px;
            text-align: center;
            background: var(--gray-4);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
        }

        .queue-actions {
            display: flex;
            gap: var(--spacing-xs);
        }

        .queue-action-btn {
            width: 24px;
            height: 24px;
            border-radius: 12px;
            border: 1px solid var(--gray-3);
            background: var(--background);
            color: var(--gray-1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .queue-action-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .queue-action-btn.remove:hover {
            background: var(--danger);
            border-color: var(--danger);
        }

        /* Update these styles */
        .queue-team {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .queue-team .player-chip {
            background: var(--background);
            border: 1px solid var(--gray-3);
            border-radius: var(--radius-md);
            padding: var(--spacing-sm) var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .queue-team .player-chip-name {
            font-weight: 500;
        }

        .queue-team .skill-badge {
            background: var(--gray-4);
            color: var(--gray-1);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        /* Add these styles to the existing CSS section */
        .queue-item {
            cursor: grab;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .queue-item:active {
            cursor: grabbing;
        }

        .queue-item.dragging {
            opacity: 0.5;
            transform: scale(0.98);
            box-shadow: var(--shadow-lg);
        }

        .queue-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .queue-action-btn {
            opacity: 0.7;
            transition: opacity 0.2s ease, background-color 0.2s ease, color 0.2s ease;
        }

        .queue-action-btn:hover {
            opacity: 1;
        }

        .queue-action-btn.remove:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    <h2>Players</h2>
                    <button class="button" id="addPlayersBtn">Add Players</button>
                </div>
                <div class="search-box">
                    <input type="text" placeholder="Search players...">
                </div>
            </div>
            
            <div class="players-list" id="playersList">
                <!-- Example of a player card -->
                <div class="player-card">
                    <div class="player-info">
                        <div class="player-name">John Doe</div>
                        <div class="player-status">
                            <span class="status-chip playing">Playing</span>
                            <span class="status-chip queued">Queued</span>
                            <span class="skill-badge">4</span>
                        </div>
                    </div>
                </div>

                <!-- Empty state -->
                <div class="empty-state">
                    <div class="empty-state-icon">üë•</div>
                    <p>No players added yet</p>
                    <p>Add players to start managing games</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="main-header">
                <h1 class="main-header-title">Badminton Queue Manager</h1>
                <div class="main-header-actions">
                    <button class="button" id="addCourtBtn">Add Court</button>
                </div>
            </div>
            <div class="courts-container">
                <!-- Courts will be rendered here -->
            </div>
        </main>
    </div>

    <!-- Dialogs -->
    <dialog id="addPlayersDialog" class="dialog">
        <div class="dialog-header">
            <h2>Add Players</h2>
        </div>
        <div class="dialog-content">
            <div class="dialog-tabs">
                <button class="dialog-tab active" data-tab="single">Single Player</button>
                <button class="dialog-tab" data-tab="bulk">Bulk Import</button>
            </div>
            
            <div class="dialog-tab-content" id="singlePlayerForm">
                <div class="form-group">
                    <label for="playerName">Player Name</label>
                    <input type="text" id="playerName" placeholder="Enter player name">
                </div>
            </div>

            <div class="dialog-tab-content hidden" id="bulkImportForm">
                <div class="form-group">
                    <label>Player Names</label>
                    <div class="bulk-import-container">
                        <textarea 
                            placeholder="Add multiple players (one per line)"
                            rows="8"
                        ></textarea>
                        <div class="bulk-import-preview">
                            <div class="preview-header">
                                <span>Preview</span>
                                <span class="preview-count">0 players</span>
                            </div>
                            <div class="preview-list"></div>
                        </div>
                    </div>
                    <div class="form-help">Press Enter after each name or paste a list of names</div>
                </div>
            </div>
        </div>
        <div class="dialog-actions">
            <button type="button" class="button secondary" id="cancelAddPlayers">Cancel</button>
            <button type="button" class="button" id="confirmAddPlayers">Add Players</button>
        </div>
    </dialog>

    <dialog id="playerSelectionDialog" class="dialog">
        <div class="dialog-header">
            <h2>Select Player</h2>
        </div>
        <div class="dialog-content">
            <div class="search-box">
                <input type="text" id="playerSearchInput" placeholder="Search players...">
            </div>
            <div id="playersGrid" class="players-grid">
                <!-- Players will be populated here -->
            </div>
        </div>
        <div class="dialog-actions">
            <button type="button" class="button secondary" id="cancelPlayerSelection">Cancel</button>
            <button type="button" class="button" id="confirmPlayerSelection">Add to Team</button>
        </div>
    </dialog>

    <!-- Audio Elements -->
    <audio id="gameStartSound" src="path-to-start-sound.mp3"></audio>
    <audio id="gameEndSound" src="path-to-end-sound.mp3"></audio>

    <!-- Replace the existing mobile menu button with this -->
    <button class="mobile-menu-button">
        <span>üë•</span>
        <span>View Players</span>
    </button>

    <script>
        // Core data structures
        class Player {
            constructor(id, name, skillLevel = 1) {
                this.id = id;
                this.name = name;
                this.skillLevel = skillLevel;
                this.status = new Set(['waiting']);
                this.gamesPlayed = 0;  // Add games counter
            }
        }

        class PlayerManager {
            constructor() {
                this.players = new Map();
                this.listeners = new Set();
            }

            addPlayer(name, skillLevel = 1) {
                const id = crypto.randomUUID();
                const player = new Player(id, name, skillLevel);
                this.players.set(player.id, player);
                this.notifyListeners();
                return player;
            }

            bulkAddPlayers(players) {
                players.forEach(({ name, skillLevel }) => {
                    this.addPlayer(name, skillLevel);
                });
            }

            removePlayer(playerId) {
                this.players.delete(playerId);
                this.notifyListeners();
            }

            updatePlayerStatus(playerId, status, add = true) {
                const player = this.players.get(playerId);
                if (player) {
                    if (add) {
                        player.status.add(status);
                    } else {
                        player.status.delete(status);
                    }
                    this.notifyListeners();
                }
            }

            getFilteredPlayers(searchTerm = '') {
                const term = searchTerm.toLowerCase();
                return Array.from(this.players.values())
                    .filter(player => player.name.toLowerCase().includes(term));
            }

            addListener(callback) {
                this.listeners.add(callback);
            }

            removeListener(callback) {
                this.listeners.delete(callback);
            }

            notifyListeners() {
                console.log('Notifying listeners, current players:', this.players.size);
                this.listeners.forEach(callback => callback(this.players));
            }
        }

        // Add these classes after the PlayerManager class

        class Team {
            constructor() {
                this.players = new Set();
            }

            addPlayer(playerId) {
                this.players.add(playerId);
            }

            removePlayer(playerId) {
                this.players.delete(playerId);
            }

            clear() {
                this.players.clear();
            }
        }

        class Game {
            constructor() {
                this.team1 = new Team();
                this.team2 = new Team();
                this.startTime = null;
                this.elapsedTime = 0;
                this.status = 'pending'; // pending, active, finished
                this.timer = null;
            }

            addPlayer(teamNumber, playerId) {
                const team = teamNumber === 1 ? this.team1 : this.team2;
                if (team.players.size < 2 && !team.players.has(playerId)) {
                    team.addPlayer(playerId);
                    return true;
                }
                return false;
            }

            removePlayer(teamNumber, playerId) {
                const team = teamNumber === 1 ? this.team1 : this.team2;
                team.removePlayer(playerId);
                if (this.status === 'active') {
                    this.end(); // End game if a player is removed during active game
                }
            }

            start() {
                this.startTime = Date.now();
                this.status = 'active';
                this.elapsedTime = 0;
                // Set up timer update callback if not already set
                if (!this.onTimerUpdate) {
                    this.setTimerUpdateCallback((elapsedTime) => {
                        if (this.status === 'active') {
                            this.elapsedTime = elapsedTime;
                        }
                    });
                }
                this.startTimer();
            }

            startTimer() {
                if (this.timer) {
                    clearInterval(this.timer);
                }
                
                // Calculate initial elapsed time if game was previously started
                if (this.startTime) {
                    this.elapsedTime = Math.floor((Date.now() - this.startTime) / 1000);
                }

                this.timer = setInterval(() => {
                    if (this.startTime && this.status === 'active') {  // Add status check
                        this.elapsedTime = Math.floor((Date.now() - this.startTime) / 1000);
                        // Emit timer update event
                        if (this.onTimerUpdate) {
                            this.onTimerUpdate(this.elapsedTime);
                        }
                    }
                }, 1000);
            }

            end() {
                if (this.timer) {
                    clearInterval(this.timer);
                    this.timer = null;
                }
                this.status = 'finished';
                const endTime = Date.now();
                this.elapsedTime = Math.floor((endTime - this.startTime) / 1000);
                return {
                    team1Players: Array.from(this.team1.players),
                    team2Players: Array.from(this.team2.players),
                    duration: this.elapsedTime
                };
            }

            isReady() {
                return this.team1.players.size === 2 && this.team2.players.size === 2;
            }

            setTimerUpdateCallback(callback) {
                this.onTimerUpdate = callback;
            }
        }

        class Court {
            constructor(id, name) {
                this.id = id;
                this.name = name;
                this.currentGame = new Game();
                this.queue = [];
                this.queueTeams = [{ team1: [], team2: [] }]; // Current building teams
            }

            addToQueue(game) {
                this.queue.push(game);
                return true;
            }

            removeFromQueue(index) {
                if (index >= 0 && index < this.queue.length) {
                    this.queue.splice(index, 1);
                    return true;
                }
                return false;
            }

            rename(newName) {
                this.name = newName;
            }
        }

        class CourtManager {
            constructor(playerManager) {
                this.courts = new Map();
                this.playerManager = playerManager;
                this.listeners = new Set();
                this.nextCourtId = 1;
            }

            createCourt(name = null) {
                const courtId = `court_${this.nextCourtId++}`;
                const courtName = name || `Court ${this.courts.size + 1}`;
                const court = new Court(courtId, courtName);
                this.courts.set(courtId, court);
                this.notifyListeners();
                return court;
            }

            removeCourt(courtId) {
                const court = this.courts.get(courtId);
                if (court) {
                    // End current game if active
                    if (court.currentGame.status === 'active') {
                        court.endCurrentGame();
                    }
                    this.courts.delete(courtId);
                    this.notifyListeners();
                }
            }

            renameCourt(courtId, newName) {
                const court = this.courts.get(courtId);
                if (court) {
                    court.rename(newName);
                    this.notifyListeners();
                }
            }

            addPlayerToGame(courtId, teamNumber, playerId) {
                const court = this.courts.get(courtId);
                if (court && court.currentGame) {
                    if (court.currentGame.addPlayer(teamNumber, playerId)) {
                        // Remove resting and playing statuses when player is marked as ready
                        this.playerManager.updatePlayerStatus(playerId, 'resting', false);
                        this.playerManager.updatePlayerStatus(playerId, 'playing', false);
                        // Add ready status and remove waiting status
                        this.playerManager.updatePlayerStatus(playerId, 'ready', true);
                        this.playerManager.updatePlayerStatus(playerId, 'waiting', false);
                        this.notifyListeners();
                        return true;
                    }
                }
                return false;
            }

            removePlayerFromGame(courtId, teamNumber, playerId) {
                const court = this.courts.get(courtId);
                if (court && court.currentGame) {
                    court.currentGame.removePlayer(teamNumber, playerId);
                    this.playerManager.updatePlayerStatus(playerId, 'playing', false);
                    this.playerManager.updatePlayerStatus(playerId, 'ready', false);  // Remove ready status
                    this.notifyListeners();
                }
            }

            swapPlayer(courtId, teamNumber, oldPlayerId) {
                // Store the context for the swap
                this.swapContext = { courtId, teamNumber, oldPlayerId };
                return true;
            }

            addListener(callback) {
                this.listeners.add(callback);
            }

            removeListener(callback) {
                this.listeners.delete(callback);
            }

            notifyListeners(type = null, data = null) {
                this.listeners.forEach(callback => callback(this.courts, type, data));
            }

            startGame(courtId) {
                const court = this.courts.get(courtId);
                if (!court || !court.currentGame.isReady()) return false;

                // Update player statuses
                const allPlayers = [
                    ...Array.from(court.currentGame.team1.players),
                    ...Array.from(court.currentGame.team2.players)
                ];

                allPlayers.forEach(playerId => {
                    this.playerManager.updatePlayerStatus(playerId, 'ready', false);  // Remove ready status
                    this.playerManager.updatePlayerStatus(playerId, 'playing', true);
                    this.playerManager.updatePlayerStatus(playerId, 'waiting', false);
                    this.playerManager.updatePlayerStatus(playerId, 'queued', false);
                    this.playerManager.updatePlayerStatus(playerId, 'resting', false);
                });

                // Set up timer update callback
                court.currentGame.setTimerUpdateCallback((elapsedTime) => {
                    this.notifyListeners('timer', { courtId, elapsedTime });
                });

                court.currentGame.start();
                this.notifyListeners();
                return true;
            }

            endGame(courtId) {
                const court = this.courts.get(courtId);
                if (!court || court.currentGame.status !== 'active') return false;

                const gameResult = court.currentGame.end();
                const allPlayers = [...gameResult.team1Players, ...gameResult.team2Players];

                // Update player statuses and increment games
                allPlayers.forEach(playerId => {
                    const player = this.playerManager.players.get(playerId);
                    if (player) {
                        player.gamesPlayed++;
                        this.playerManager.updatePlayerStatus(playerId, 'playing', false);
                        // Only set resting status if they're not about to play in the next game
                        const nextGame = court.queue[0];
                        const willPlayNext = nextGame && (
                            nextGame.team1.players.has(playerId) || 
                            nextGame.team2.players.has(playerId)
                        );
                        if (!willPlayNext) {
                            this.playerManager.updatePlayerStatus(playerId, 'resting', true);
                        }
                    }
                });

                // Create new game and try to fill from queue
                court.currentGame = new Game();
                if (court.queue.length > 0) {
                    const nextGame = court.queue.shift();
                    court.currentGame = nextGame;
                    
                    // Update queued players' status
                    [...nextGame.team1.players, ...nextGame.team2.players].forEach(playerId => {
                        this.playerManager.updatePlayerStatus(playerId, 'queued', false);
                        // Remove resting status if they had it
                        this.playerManager.updatePlayerStatus(playerId, 'resting', false);
                    });
                }

                this.notifyListeners();
                return true;
            }

            addMatchToQueue(courtId, team1Players, team2Players) {
                const court = this.courts.get(courtId);
                if (court && court.queueTeams?.[0]) {
                    const { team1, team2 } = court.queueTeams[0];
                    if (team1.length === 2 && team2.length === 2) {
                        const game = new Game();
                        team1.forEach(playerId => game.addPlayer(1, playerId));
                        team2.forEach(playerId => game.addPlayer(2, playerId));
                        court.queue.push(game);
                        court.queueTeams = [{ team1: [], team2: [] }]; // Reset queue teams
                        this.notifyListeners();
                        return true;
                    }
                }
                return false;
            }

            removeFromQueue(courtId, queueIndex) {
                const court = this.courts.get(courtId);
                if (court) {
                    const game = court.queue[queueIndex];
                    if (game) {
                        // Remove queued status from players
                        [...game.team1.players, ...game.team2.players].forEach(playerId => {
                            this.playerManager.updatePlayerStatus(playerId, 'queued', false);
                        });
                    }
                    court.removeFromQueue(queueIndex);
                    this.notifyListeners();
                }
            }

            moveQueueItem(courtId, fromIndex, toIndex) {
                const court = this.courts.get(courtId);
                if (court && fromIndex !== toIndex) {
                    const game = court.queue.splice(fromIndex, 1)[0];
                    court.queue.splice(toIndex, 0, game);
                    this.notifyListeners();
                }
            }

            addPlayerToQueue(courtId, teamNumber, playerId) {
                const court = this.courts.get(courtId);
                if (!court) return false;

                const player = this.playerManager.players.get(playerId);
                if (!player) return false;

                // Check if player is already in a game or queue
                if (player.status.has('playing') || player.status.has('queued')) {
                    return false;
                }

                const team = teamNumber === 1 ? court.queueTeams[0].team1 : court.queueTeams[0].team2;
                const otherTeam = teamNumber === 1 ? court.queueTeams[0].team2 : court.queueTeams[0].team1;

                // Check if player is already in either team
                if (!team.includes(playerId) && !otherTeam.includes(playerId) && team.length < 2) {
                    team.push(playerId);
                    this.playerManager.updatePlayerStatus(playerId, 'queued', true);

                    // If both teams are complete, create a new game
                    if (court.queueTeams[0].team1.length === 2 && court.queueTeams[0].team2.length === 2) {
                        const newGame = new Game();
                        court.queueTeams[0].team1.forEach(id => newGame.addPlayer(1, id));
                        court.queueTeams[0].team2.forEach(id => newGame.addPlayer(2, id));
                        court.addToQueue(newGame);
                        court.queueTeams = [{ team1: [], team2: [] }]; // Reset teams
                    }

                    this.notifyListeners();
                    return true;
                }
                return false;
            }

            removePlayerFromQueue(courtId, teamNumber, playerId) {
                const court = this.courts.get(courtId);
                if (!court) return false;

                const team = teamNumber === 1 ? court.queueTeams[0].team1 : court.queueTeams[0].team2;
                const index = team.indexOf(playerId);
                
                if (index !== -1) {
                    team.splice(index, 1);
                    this.playerManager.updatePlayerStatus(playerId, 'queued', false);
                    this.notifyListeners();
                    return true;
                }
                return false;
            }
        }

        // UI Manager for handling DOM updates
        class UIManager {
            constructor(playerManager, courtManager, queueManager) {
                this.playerManager = playerManager;
                this.courtManager = courtManager;
                this.queueManager = queueManager;
                
                // Initialize after DOM is ready
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.initialize());
                } else {
                    this.initialize();
                }
            }

            renderMainContent() {
                return `
                    <div class="main-content">
                        <div class="courts-section">
                            ${this.renderCourts()}
                        </div>
                        <div class="queue-section">
                            <h2>Queue</h2>
                            <div class="queue-builder">
                                <div class="team-builder">
                                    <h3>Team 1</h3>
                                    <div class="empty-slot" data-action="add-queue-player" data-team="1">
                                        <span>Add player</span>
                                    </div>
                                    <div class="empty-slot" data-action="add-queue-player" data-team="1">
                                        <span>Add player</span>
                                    </div>
                                </div>
                                <div class="vs-badge">VS</div>
                                <div class="team-builder">
                                    <h3>Team 2</h3>
                                    <div class="empty-slot" data-action="add-queue-player" data-team="2">
                                        <span>Add player</span>
                                    </div>
                                    <div class="empty-slot" data-action="add-queue-player" data-team="2">
                                        <span>Add player</span>
                                    </div>
                                </div>
                            </div>
                            <div class="queue-list">
                                ${this.renderQueueList()}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderBuildingMatch() {
                return `
                    <div class="teams-container">
                        <div class="team" data-team="1">
                            <div class="team-header">
                                <h4>Team 1</h4>
                            </div>
                            <div class="team-players">
                                ${this.renderBuildingTeamPlayers(1)}
                            </div>
                        </div>
                        <div class="vs-badge">VS</div>
                        <div class="team" data-team="2">
                            <div class="team-header">
                                <h4>Team 2</h4>
                            </div>
                            <div class="team-players">
                                ${this.renderBuildingTeamPlayers(2)}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderBuildingTeamPlayers(teamNumber) {
                const team = teamNumber === 1 ? this.queueManager.buildingTeams.team1 : this.queueManager.buildingTeams.team2;
                const slotsNeeded = 2 - team.length;

                return `
                    ${team.map(playerId => {
                        const player = this.playerManager.players.get(playerId);
                        return `
                            <div class="player-chip" data-player-id="${playerId}">
                                <div class="player-chip-content">
                                    <span class="player-chip-name">${player.name}</span>
                                    <span class="skill-badge">Lvl ${player.skillLevel}</span>
                                </div>
                                <button class="chip-action remove" data-action="remove-queue-player">‚úï</button>
                            </div>
                        `;
                    }).join('')}
                    ${Array(slotsNeeded).fill(`
                        <div class="empty-slot" data-action="add-queue-player" data-team="${teamNumber}">
                            <span>Add player</span>
                        </div>
                    `).join('')}
                `;
            }

            renderQueueList() {
                if (this.queueManager.queue.length === 0) {
                    return '<div class="empty-queue">No matches in queue</div>';
                }

                return this.queueManager.queue.map((match, index) => `
                    <div class="queue-match" draggable="true" data-index="${index}">
                        <div class="queue-match-teams">
                            <div class="queue-team">
                                ${match.team1.map(playerId => {
                                    const player = this.playerManager.players.get(playerId);
                                    return `<span class="player-name">${player.name}</span>`;
                                }).join(' & ')}
                            </div>
                            <div class="vs-text">vs</div>
                            <div class="queue-team">
                                ${match.team2.map(playerId => {
                                    const player = this.playerManager.players.get(playerId);
                                    return `<span class="player-name">${player.name}</span>`;
                                }).join(' & ')}
                            </div>
                        </div>
                        <button class="remove-match" data-action="remove-match">‚úï</button>
                    </div>
                `).join('');
            }

            renderQueuePlayer(playerId) {
                const player = this.playerManager.players.get(playerId);
                const isResting = player.status.has('resting');
                return `
                    <div class="queue-player ${isResting ? 'resting' : ''}" data-player-id="${playerId}">
                        <span class="player-name">${player.name}</span>
                        <div class="player-indicators">
                            ${isResting ? '<span class="rest-indicator" title="Player is resting">üí§</span>' : ''}
                            <span class="games-badge">üéÆ ${player.gamesPlayed} Games</span>
                        </div>
                    </div>
                `;
            }

            formatWaitTime(createdAt) {
                const minutes = Math.floor((Date.now() - createdAt) / 60000);
                if (minutes < 5) return `${minutes}m`;
                if (minutes < 60) return `‚ö†Ô∏è ${minutes}m`;
                return `‚ö†Ô∏è ${Math.floor(minutes/60)}h ${minutes%60}m`;
            }

            initializeElements() {
                this.elements = {
                    playerSelectionDialog: document.getElementById('playerSelectionDialog'),
                    playerSearchInput: document.getElementById('playerSearchInput'),
                    playersGrid: document.getElementById('playersGrid'),
                    confirmPlayerSelection: document.getElementById('confirmPlayerSelection'),
                    cancelPlayerSelection: document.getElementById('cancelPlayerSelection'),
                    addPlayersBtn: document.getElementById('addPlayersBtn'),
                    addPlayersDialog: document.getElementById('addPlayersDialog'),
                    playersList: document.getElementById('playersList'),
                    courtsContainer: document.querySelector('.courts-container'),
                    addCourtBtn: document.getElementById('addCourtBtn'),
                    searchInput: document.querySelector('.sidebar .search-box input'),
                    mobileMenuBtn: document.querySelector('.mobile-menu-button'),
                    sidebar: document.querySelector('.sidebar'),
                    dialogTabs: document.querySelectorAll('.dialog-tab'),
                    singlePlayerForm: document.getElementById('singlePlayerForm'),
                    bulkImportForm: document.getElementById('bulkImportForm'),
                    playerNameInput: document.getElementById('playerName'),
                    confirmAddPlayers: document.getElementById('confirmAddPlayers'),
                    bulkTextarea: document.querySelector('#bulkImportForm textarea'),
                    previewList: document.querySelector('#bulkImportForm .preview-list'),
                    previewCount: document.querySelector('#bulkImportForm .preview-count'),
                    queueMatchDialog: document.getElementById('queueMatchDialog')
                };

                // Verify all elements exist
                Object.entries(this.elements).forEach(([key, element]) => {
                    if (!element) {
                        console.error(`Missing element: ${key}`);
                    }
                });
            }

            setupEventListeners() {
                // Verify required elements exist before setting up listeners
                if (!this.elements.playerSearchInput || 
                    !this.elements.playersGrid || 
                    !this.elements.confirmPlayerSelection || 
                    !this.elements.cancelPlayerSelection) {
                    console.error('Missing required elements for player selection dialog');
                    return;
                }

                // Player Selection Dialog
                this.elements.playerSearchInput.addEventListener('input', (e) => {
                    this.renderPlayerSelection(e.target.value);
                });

                this.elements.playersGrid.addEventListener('click', (e) => {
                    const item = e.target.closest('.player-selection-item');
                    if (item) {
                        this.elements.playersGrid.querySelectorAll('.player-selection-item').forEach(i => 
                            i.classList.remove('selected')
                        );
                        item.classList.add('selected');
                    }
                });

                this.elements.confirmPlayerSelection.addEventListener('click', () => {
                    const selectedPlayer = this.elements.playersGrid.querySelector('.selected');
                    if (selectedPlayer) {
                        const dialog = this.elements.playerSelectionDialog;
                        const courtId = dialog.dataset.courtId;
                        const teamNumber = parseInt(dialog.dataset.teamNumber);
                        const playerId = selectedPlayer.dataset.playerId;
                        const isQueue = dialog.dataset.isQueue === 'true';

                        if (isQueue) {
                            this.addPlayerToQueueTeam(courtId, teamNumber, playerId);
                        } else {
                            this.addPlayerToGameTeam(courtId, teamNumber, playerId);
                        }
                        dialog.close();
                    }
                });

                this.elements.cancelPlayerSelection.addEventListener('click', () => {
                    this.elements.playerSelectionDialog.close();
                });

                // Add Players Dialog
                this.elements.addPlayersBtn.addEventListener('click', () => {
                    const addPlayersDialog = document.getElementById('addPlayersDialog');
                    addPlayersDialog.showModal();
                });

                // Add Players Dialog - Cancel button
                document.getElementById('cancelAddPlayers').addEventListener('click', () => {
                    document.getElementById('addPlayersDialog').close();
                });

                // Add Players Dialog - Confirm button
                document.getElementById('confirmAddPlayers').addEventListener('click', () => {
                    const activeTab = document.querySelector('.dialog-tab.active').dataset.tab;
                    
                    if (activeTab === 'single') {
                        const name = document.getElementById('playerName').value.trim();
                        if (name) {
                            this.playerManager.addPlayer(name, 1);
                            document.getElementById('playerName').value = '';
                        }
                    } else {
                        const textarea = document.querySelector('#bulkImportForm textarea');
                        const names = textarea.value
                            .split('\n')
                            .map(name => name.trim())
                            .filter(name => name.length > 0);
                            
                        if (names.length > 0) {
                            names.forEach(name => {
                                this.playerManager.addPlayer(name, 1);
                            });
                            textarea.value = '';
                        }
                    }
                    
                    document.getElementById('addPlayersDialog').close();
                });

                // Dialog tabs
                this.elements.dialogTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabName = tab.dataset.tab;
                        this.elements.dialogTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        this.elements.singlePlayerForm.classList.toggle('hidden', tabName !== 'single');
                        this.elements.bulkImportForm.classList.toggle('hidden', tabName !== 'bulk');
                    });
                });

                // Handle Enter key in single player input
                this.elements.playerNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.elements.confirmAddPlayers.click();
                    }
                });

                // Add Court button
                this.elements.addCourtBtn.addEventListener('click', () => {
                    this.courtManager.createCourt();
                });

                // Search players
                this.elements.searchInput.addEventListener('input', (e) => {
                    this.renderPlayersList(e.target.value);
                });

                // Mobile menu
                this.elements.mobileMenuBtn.addEventListener('click', () => {
                    this.elements.sidebar.classList.toggle('active');
                });
            }

            setupPlayerManagerListeners() {
                this.playerManager.addListener(() => {
                    this.renderPlayersList();
                });
            }

            parsePlayerInput(input) {
                return input.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0)
                    .map(line => {
                        const [name, skillLevel] = line.split(',').map(s => s.trim());
                        return {
                            name,
                            skillLevel: parseInt(skillLevel) || 1
                        };
                    });
            }

            renderPlayersList(searchTerm = '') {
                const players = this.playerManager.getFilteredPlayers(searchTerm);
                
                if (players.length === 0) {
                    this.elements.playersList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üë•</div>
                            <p>No players found</p>
                            <p>Add players to start managing games</p>
                        </div>
                    `;
                    return;
                }

                this.elements.playersList.innerHTML = players.map(player => `
                    <div class="player-card" data-player-id="${player.id}">
                        <div class="player-info">
                            <div class="player-name">${player.name}</div>
                            <div class="player-status">
                                ${Array.from(player.status).map(status => `
                                    <span class="status-chip ${status}">
                                        ${this.getStatusIcon(status)} ${this.capitalizeFirst(status)}
                                    </span>
                                `).join('')}
                                <span class="skill-badge">Lvl ${player.skillLevel}</span>
                                <span class="games-badge">üéÆ ${player.gamesPlayed} Games</span>
                            </div>
                        </div>
                        <div class="player-actions">
                            <button class="player-action-btn" title="Edit player">‚úèÔ∏è</button>
                            <button class="player-action-btn" title="Remove player">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('');

                this.setupPlayerCardListeners();
            }

            getStatusIcon(status) {
                const icons = {
                    waiting: '‚åõ',
                    playing: 'üè∏',
                    queued: 'üéüÔ∏è',
                    resting: 'üí§',
                    ready: '‚úÖ'  /* Add checkmark emoji for ready status */
                };
                return icons[status] || '';
            }

            capitalizeFirst(str) {
                return str.charAt(0).toUpperCase() + str.slice(1);
            }

            setupPlayerCardListeners() {
                const playerCards = this.elements.playersList.querySelectorAll('.player-card');
                
                playerCards.forEach(card => {
                    const playerId = card.dataset.playerId;
                    
                    // Edit button
                    card.querySelector('.player-action-btn[title="Edit player"]').addEventListener('click', (e) => {
                        e.stopPropagation();
                        // TODO: Implement edit player functionality
                        console.log('Edit player:', playerId);
                    });

                    // Remove button
                    card.querySelector('.player-action-btn[title="Remove player"]').addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (confirm('Are you sure you want to remove this player?')) {
                            this.playerManager.removePlayer(playerId);
                        }
                    });
                });
            }

            updateBulkImportPreview() {
                const names = this.elements.bulkTextarea.value
                    .split('\n')
                    .map(name => name.trim())
                    .filter(name => name.length > 0);

                const validNames = new Set();
                const previewHTML = names.map(name => {
                    const isValid = this.isValidPlayerName(name) && !validNames.has(name.toLowerCase());
                    if (isValid) {
                        validNames.add(name.toLowerCase());
                    }
                    return `
                        <div class="preview-item ${isValid ? '' : 'invalid'}">
                            ${isValid ? '‚úì' : '‚úó'} ${this.escapeHtml(name)}
                            ${isValid ? '' : ' - ' + this.getInvalidReason(name, validNames)}
                        </div>
                    `;
                }).join('');

                this.elements.previewList.innerHTML = previewHTML || `
                    <div class="preview-item">No players added yet</div>
                `;
                this.elements.previewCount.textContent = `${validNames.size} valid player${validNames.size !== 1 ? 's' : ''}`;
            }

            getValidNamesFromBulkInput() {
                const names = this.elements.bulkTextarea.value
                    .split('\n')
                    .map(name => name.trim())
                    .filter(name => name.length > 0);

                const validNames = new Set();
                return names.filter(name => {
                    const isValid = this.isValidPlayerName(name) && !validNames.has(name.toLowerCase());
                    if (isValid) {
                        validNames.add(name.toLowerCase());
                    }
                    return isValid;
                });
            }

            isValidPlayerName(name) {
                return name.length >= 2 && name.length <= 50 && /^[a-zA-Z0-9\s'-]+$/.test(name);
            }

            getInvalidReason(name, validNames) {
                if (name.length < 2) return 'Name too short';
                if (name.length > 50) return 'Name too long';
                if (!(/^[a-zA-Z0-9\s'-]+$/.test(name))) return 'Invalid characters';
                if (validNames.has(name.toLowerCase())) return 'Duplicate name';
                return 'Invalid name';
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            setupCourtManagerListeners() {
                this.courtManager.addListener((courts, type, data) => {
                    if (type === 'timer' && data) {
                        this.updateGameTimer(data.courtId, data.elapsedTime);
                    } else {
                        this.renderCourts();
                    }
                });

                // Add court button
                this.elements.addCourtBtn.addEventListener('click', () => {
                    console.log('Creating new court...');
                    this.courtManager.createCourt();
                });
            }

            renderCourts() {
                const courts = Array.from(this.courtManager.courts.values());
                console.log('Rendering courts:', courts);
                
                if (courts.length === 0) {
                    this.elements.courtsContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üéæ</div>
                            <p>No courts available</p>
                            <p>Add a court to start managing games</p>
                        </div>
                    `;
                    return;
                }

                this.elements.courtsContainer.innerHTML = courts.map(court => this.renderCourtCard(court)).join('');
                console.log('Courts rendered, setting up event listeners...');
                this.setupCourtEventListeners();
            }

            renderCourtCard(court) {
                const gameStatus = court.currentGame.status;
                const isGameActive = gameStatus === 'active';
                
                return `
                    <div class="court-card" data-court-id="${court.id}">
                        <div class="court-header">
                            <div class="court-title">
                                <span class="court-name" data-court-name>${court.name}</span>
                                <span class="court-status ${isGameActive ? 'active' : ''}">${isGameActive ? 'In Progress' : 'Available'}</span>
                            </div>
                            <div class="court-actions">
                                <button class="button secondary small" data-action="rename">Rename</button>
                                <button class="button danger small" data-action="remove">Remove</button>
                            </div>
                        </div>
                        
                        <div class="game-section">
                            <div class="section-header">
                                <h3>Current Game</h3>
                                <span class="game-timer">${this.formatTime(court.currentGame.elapsedTime)}</span>
                            </div>
                            <div class="teams-container">
                                ${this.renderTeam(court, 1)}
                                <div class="vs-badge">VS</div>
                                ${this.renderTeam(court, 2)}
                            </div>
                            <div class="game-actions">
                                <button class="button" 
                                    data-action="toggle-game" 
                                    ${!court.currentGame.isReady() ? 'disabled' : ''}>
                                    ${isGameActive ? 'End Game' : 'Start Game'}
                                </button>
                            </div>
                        </div>

                        <div class="queue-section">
                            <div class="section-header">
                                <h3>Queue</h3>
                                <!-- Remove this button -->
                                <!-- <button class="button-icon" title="Add match to queue" data-action="add-to-queue">+</button> -->
                            </div>
                            <div class="queue-list">
                                ${this.renderQueueList(court)}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderTeam(court, teamNumber) {
                const team = teamNumber === 1 ? court.currentGame.team1 : court.currentGame.team2;
                const players = Array.from(team.players).map(id => this.playerManager.players.get(id));
                const slotsNeeded = 2 - players.length;

                return `
                    <div class="team" data-team="${teamNumber}">
                        <div class="team-header">
                            <h4>Team ${teamNumber}</h4>
                        </div>
                        <div class="team-players">
                            ${players.map(player => `
                                <div class="player-chip" data-player-id="${player.id}">
                                    <div class="player-chip-content">
                                        <span class="player-chip-name">${player.name}</span>
                                        <span class="skill-badge">Lvl ${player.skillLevel}</span>
                                    </div>
                                    <div class="player-chip-actions">
                                        <button class="chip-action swap" title="Swap player" data-action="swap-player">üîÑ</button>
                                        <button class="chip-action remove" title="Remove player" data-action="remove-player">‚úï</button>
                                    </div>
                                </div>
                            `).join('')}
                            ${Array(slotsNeeded).fill(`
                                <div class="empty-slot" data-action="add-player" data-team="${teamNumber}">
                                    <span>Add player</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            renderQueueList(court) {
                return `
                    <div class="queue-matches">
                        <div class="teams-container queue-teams">
                            <div class="team" data-team="1">
                                <div class="team-players">
                                    ${this.renderQueueTeamPlayers(court, 1)}
                                </div>
                            </div>
                            <div class="vs-badge">VS</div>
                            <div class="team" data-team="2">
                                <div class="team-players">
                                    ${this.renderQueueTeamPlayers(court, 2)}
                                </div>
                            </div>
                        </div>
                    </div>

                    ${court.queue.length ? this.renderQueuedMatches(court) : ''}
                `;
            }

            renderQueueTeamPlayers(court, teamNumber) {
                const team = court.queueTeams?.[0]?.[`team${teamNumber}`] || [];
                const slotsNeeded = 2 - team.length;

                return `
                    ${team.map(playerId => {
                        const player = this.playerManager.players.get(playerId);
                        return `
                            <div class="player-chip" data-player-id="${playerId}">
                                <div class="player-chip-content">
                                    <span class="player-chip-name">${player.name}</span>
                                    <span class="skill-badge">Lvl ${player.skillLevel}</span>
                                </div>
                                <button class="chip-action remove" data-action="remove-queue-player">‚úï</button>
                            </div>
                        `;
                    }).join('')}
                    ${Array(slotsNeeded).fill(`
                        <div class="empty-slot" data-action="add-queue-player" data-team="${teamNumber}">
                            <span>Add player</span>
                        </div>
                    `).join('')}
                `;
            }

            renderQueuedMatches(court) {
                if (court.queue.length === 0) return '';
                
                return `
                    <div class="queued-matches">
                        <h4>Queued Matches (${court.queue.length})</h4>
                        ${court.queue.map((game, index) => `
                            <div class="queue-item" draggable="true" data-queue-index="${index}">
                                <div class="queue-item-header">
                                    <span class="queue-number">Match ${index + 1}</span>
                                    <div class="queue-actions">
                                        ${index > 0 ? `
                                            <button class="queue-action-btn" title="Move up" data-action="move-up">‚Üë</button>
                                        ` : ''}
                                        ${index < court.queue.length - 1 ? `
                                            <button class="queue-action-btn" title="Move down" data-action="move-down">‚Üì</button>
                                        ` : ''}
                                        <button class="queue-action-btn remove" title="Remove from queue" data-action="remove-queue">√ó</button>
                                    </div>
                                </div>
                                <div class="queue-teams">
                                    <div class="queue-team">
                                        ${Array.from(game.team1.players).map(playerId => {
                                            const player = this.playerManager.players.get(playerId);
                                            return `
                                                <div class="player-chip">
                                                    <span class="player-chip-name">${player.name}</span>
                                                    <span class="skill-badge">Lvl ${player.skillLevel}</span>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                    <div class="vs-text">VS</div>
                                    <div class="queue-team">
                                        ${Array.from(game.team2.players).map(playerId => {
                                            const player = this.playerManager.players.get(playerId);
                                            return `
                                                <div class="player-chip">
                                                    <span class="player-chip-name">${player.name}</span>
                                                    <span class="skill-badge">Lvl ${player.skillLevel}</span>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            renderQueueItem(game, index) {
                const isBuilding = index === -1;
                return `
                    <div class="queue-item" data-queue-index="${index}">
                        <div class="queue-item-header">
                            <span class="queue-number">${isBuilding ? 'Building...' : `#${index + 1}`}</span>
                            <div class="queue-actions">
                                ${!isBuilding ? `
                                    ${index > 0 ? `
                                        <button class="button-icon small" data-action="move-up" title="Move up">‚¨ÜÔ∏è</button>
                                    ` : ''}
                                    ${index < game.queue?.length - 1 ? `
                                        <button class="button-icon small" data-action="move-down" title="Move down">‚¨áÔ∏è</button>
                                    ` : ''}
                                    <button class="button-icon small" data-action="remove-queue" title="Remove">üóëÔ∏è</button>
                                ` : ''}
                            </div>
                        </div>
                        <div class="queue-teams">
                            <div class="queue-team">
                                ${Array.from(game.team1.players).map(playerId => {
                                    const player = this.playerManager.players.get(playerId);
                                    return `
                                        <div class="player-chip small">
                                            <span>${player.name}</span>
                                            <span class="skill-badge">Lvl ${player.skillLevel}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div class="vs-label">VS</div>
                            <div class="queue-team">
                                ${Array.from(game.team2.players).map(playerId => {
                                    const player = this.playerManager.players.get(playerId);
                                    return `
                                        <div class="player-chip small">
                                            <span>${player.name}</span>
                                            <span class="skill-badge">Lvl ${player.skillLevel}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            setupCourtEventListeners() {
                const courts = this.elements.courtsContainer.querySelectorAll('.court-card');
                
                courts.forEach(courtElement => {
                    const courtId = courtElement.dataset.courtId;

                    // Handle all click events through delegation
                    courtElement.addEventListener('click', (e) => {
                        const target = e.target;

                        // Handle adding players to game
                        if (target.closest('[data-action="add-player"]')) {
                            const slot = target.closest('[data-action="add-player"]');
                            const teamNumber = parseInt(slot.dataset.team);
                            this.showPlayerSelectionDialog(courtId, teamNumber, false, false);
                        }

                        // Handle adding players to queue
                        if (target.closest('[data-action="add-queue-player"]')) {
                            const slot = target.closest('[data-action="add-queue-player"]');
                            const teamNumber = parseInt(slot.dataset.team);
                            this.showPlayerSelectionDialog(courtId, teamNumber, false, true);
                        }

                        // Handle removing players from game
                        if (target.closest('[data-action="remove-player"]')) {
                            const playerChip = target.closest('.player-chip');
                            const teamNumber = parseInt(playerChip.closest('[data-team]').dataset.team);
                            const playerId = playerChip.dataset.playerId;
                            this.courtManager.removePlayerFromGame(courtId, teamNumber, playerId);
                        }

                        // Handle removing players from queue
                        if (target.closest('[data-action="remove-queue-player"]')) {
                            const playerChip = target.closest('.player-chip');
                            const teamNumber = parseInt(playerChip.closest('[data-team]').dataset.team);
                            const playerId = playerChip.dataset.playerId;
                            this.courtManager.removePlayerFromQueue(courtId, teamNumber, playerId);
                        }

                        // Handle swapping players
                        if (target.closest('[data-action="swap-player"]')) {
                            const playerChip = target.closest('.player-chip');
                            const teamNumber = parseInt(playerChip.closest('[data-team]').dataset.team);
                            const playerId = playerChip.dataset.playerId;
                            this.showPlayerSelectionDialog(courtId, teamNumber, true, false);
                        }

                        // Handle starting/ending game
                        if (target.closest('[data-action="toggle-game"]')) {
                            const court = this.courtManager.courts.get(courtId);
                            if (court.currentGame.status === 'active') {
                                this.courtManager.endGame(courtId);
                            } else {
                                this.courtManager.startGame(courtId);
                            }
                        }

                        // Handle queue item removal
                        if (target.closest('[data-action="remove-queue"]')) {
                            const queueItem = target.closest('.queue-item');
                            const queueIndex = parseInt(queueItem.dataset.queueIndex);
                            if (confirm('Remove this match from the queue?')) {
                                this.courtManager.removeFromQueue(courtId, queueIndex);
                            }
                        }

                        // Handle queue item movement
                        if (target.closest('[data-action="move-up"]')) {
                            const queueItem = target.closest('.queue-item');
                            const queueIndex = parseInt(queueItem.dataset.queueIndex);
                            this.courtManager.moveQueueItem(courtId, queueIndex, queueIndex - 1);
                        }

                        if (target.closest('[data-action="move-down"]')) {
                            const queueItem = target.closest('.queue-item');
                            const queueIndex = parseInt(queueItem.dataset.queueIndex);
                            this.courtManager.moveQueueItem(courtId, queueIndex, queueIndex + 1);
                        }

                        // Handle court rename
                        if (target.closest('[data-action="rename"]')) {
                            const newName = prompt('Enter new court name:', this.courtManager.courts.get(courtId).name);
                            if (newName) {
                                this.courtManager.renameCourt(courtId, newName);
                            }
                        }

                        // Handle court removal
                        if (target.closest('[data-action="remove"]')) {
                            if (confirm('Are you sure you want to remove this court?')) {
                                this.courtManager.removeCourt(courtId);
                            }
                        }
                    });

                    // Add drag and drop functionality for queue items
                    const queueList = courtElement.querySelector('.queue-list');
                    if (queueList) {
                        this.setupQueueDragAndDrop(queueList, courtId);
                    }
                });
            }

            // Add this new method to handle drag and drop
            setupQueueDragAndDrop(queueList, courtId) {
                queueList.addEventListener('dragstart', (e) => {
                    const queueItem = e.target.closest('.queue-item');
                    if (queueItem) {
                        queueItem.classList.add('dragging');
                        e.dataTransfer.setData('text/plain', queueItem.dataset.queueIndex);
                    }
                });

                queueList.addEventListener('dragend', (e) => {
                    const queueItem = e.target.closest('.queue-item');
                    if (queueItem) {
                        queueItem.classList.remove('dragging');
                    }
                });

                queueList.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const draggingItem = queueList.querySelector('.queue-item.dragging');
                    if (!draggingItem) return;

                    const siblings = [...queueList.querySelectorAll('.queue-item:not(.dragging)')];
                    const nextSibling = siblings.find(sibling => {
                        const box = sibling.getBoundingClientRect();
                        return e.clientY < box.top + box.height / 2;
                    });

                    if (nextSibling) {
                        const fromIndex = parseInt(draggingItem.dataset.queueIndex);
                        const toIndex = parseInt(nextSibling.dataset.queueIndex);
                        if (fromIndex !== toIndex) {
                            this.courtManager.moveQueueItem(courtId, fromIndex, toIndex);
                        }
                    }
                });
            }

            formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }

            showPlayerSelectionDialog(courtId, teamNumber, isSwap = false, isQueue = false, queueIndex = null) {
                console.log('Opening dialog:', { courtId, teamNumber, isSwap, isQueue, queueIndex });
                const dialog = this.elements.playerSelectionDialog;
                
                dialog.dataset.courtId = courtId;
                dialog.dataset.teamNumber = teamNumber;
                dialog.dataset.isSwap = isSwap;
                dialog.dataset.isQueue = isQueue;
                dialog.dataset.queueIndex = queueIndex;

                // Update dialog title
                dialog.querySelector('h2').textContent = isQueue ? 'Add Player to Queue' : 'Add Player to Team';

                // Reset search and render players
                this.elements.playerSearchInput.value = '';
                this.renderPlayerSelection('');

                // Add click handler for direct selection
                const playersGrid = this.elements.playersGrid;
                const handleDirectSelection = (e) => {
                    const item = e.target.closest('.player-selection-item');
                    if (item) {
                        const playerId = item.dataset.playerId;
                        if (isQueue) {
                            this.addPlayerToQueueTeam(courtId, teamNumber, playerId);
                        } else {
                            this.addPlayerToGameTeam(courtId, teamNumber, playerId);
                        }
                        dialog.close();
                    }
                };

                playersGrid.addEventListener('click', handleDirectSelection);
                
                // Remove event listener when dialog closes
                dialog.addEventListener('close', () => {
                    playersGrid.removeEventListener('click', handleDirectSelection);
                }, { once: true });

                dialog.showModal();
            }

            renderPlayerSelection(searchTerm = '') {
                const players = this.playerManager.getFilteredPlayers(searchTerm);
                const playersGrid = this.elements.playersGrid;
                
                if (players.length === 0) {
                    playersGrid.innerHTML = `
                        <div class="empty-state small">
                            <p>No players found</p>
                            <p>Try a different search term</p>
                        </div>
                    `;
                    return;
                }

                playersGrid.innerHTML = players.map(player => {
                    // Remove isUnavailable check since we want to allow selection of playing/queued players
                    const statusText = this.getPlayerStatusText(player.status);
                    
                    return `
                        <div class="player-selection-item" 
                             data-player-id="${player.id}"
                             title="${statusText}"
                        >
                            <div class="player-info">
                                <div class="player-name">${player.name}</div>
                                <span class="skill-badge">Lvl ${player.skillLevel}</span>
                                <span class="games-badge">üéÆ ${player.gamesPlayed} Games</span>
                            </div>
                            <div class="player-statuses">
                                ${Array.from(player.status).map(status => 
                                    `<span class="status-chip ${status}" title="${this.capitalizeFirst(status)}">
                                        ${this.getStatusIcon(status)}
                                    </span>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                }).join('');

                // Update click handler to allow selection of all players
                playersGrid.addEventListener('click', (e) => {
                    const item = e.target.closest('.player-selection-item');
                    if (item) {
                        playersGrid.querySelectorAll('.player-selection-item').forEach(i => 
                            i.classList.remove('selected')
                        );
                        item.classList.add('selected');
                    }
                });
            }

            updateGameTimer(courtId, elapsedTime) {
                const timerElement = document.querySelector(`[data-court-id="${courtId}"] .game-timer`);
                if (timerElement) {
                    timerElement.textContent = this.formatTime(elapsedTime);
                    
                    // Add warning for long games (15+ minutes)
                    const isLongGame = elapsedTime >= 900; // 15 minutes
                    timerElement.classList.toggle('long-game', isLongGame);
                }
            }

            showQueueMatchDialog(courtId) {
                console.log('Opening queue match dialog:', { courtId });
                const dialog = this.elements.queueMatchDialog;
                
                // Store the context
                dialog.dataset.courtId = courtId;
                
                // Reset team selections
                dialog.querySelectorAll('.team-players').forEach(team => {
                    team.innerHTML = `
                        <div class="empty-slot" data-action="add-queue-player" data-team="${team.closest('.team').dataset.team}">
                            <span>Add player</span>
                        </div>
                        <div class="empty-slot" data-action="add-queue-player" data-team="${team.closest('.team').dataset.team}">
                            <span>Add player</span>
                        </div>
                    `;
                });

                // Show current queue
                const court = this.courtManager.courts.get(courtId);
                this.updateQueuePreview(court);

                dialog.showModal();
            }

            setupQueueEventListeners() {
                const queueDialog = this.elements.queueMatchDialog;
                
                // Handle player slot clicks
                queueDialog.addEventListener('click', (e) => {
                    const slot = e.target.closest('[data-action="add-queue-player"]');
                    if (slot) {
                        const teamNumber = parseInt(slot.closest('.team').dataset.team);
                        const courtId = queueDialog.dataset.courtId;
                        this.showPlayerSelectionDialog(courtId, teamNumber, false, true);
                    }
                });

                // Handle confirm button
                queueDialog.querySelector('#confirmQueueMatch').addEventListener('click', () => {
                    const courtId = queueDialog.dataset.courtId;
                    const team1Players = Array.from(queueDialog.querySelectorAll('.team[data-team="1"] .player-chip'))
                        .map(chip => chip.dataset.playerId);
                    const team2Players = Array.from(queueDialog.querySelectorAll('.team[data-team="2"] .player-chip'))
                        .map(chip => chip.dataset.playerId);
                    
                    if (team1Players.length === 2 && team2Players.length === 2) {
                        this.courtManager.addMatchToQueue(courtId, team1Players, team2Players);
                        queueDialog.close();
                    } else {
                        alert('Please add 2 players to each team');
                    }
                });

                // Handle cancel button
                queueDialog.querySelector('#cancelQueueMatch').addEventListener('click', () => {
                    queueDialog.close();
                });
            }

            updateQueueDialogTeams(teamNumber, playerId) {
                const dialog = this.elements.queueMatchDialog;
                const teamContainer = dialog.querySelector(`.team[data-team="${teamNumber}"] .team-players`);
                const player = this.playerManager.players.get(playerId);
                
                // Remove empty slots first
                teamContainer.querySelectorAll('.empty-slot').forEach(slot => slot.remove());
                
                // Add player chip
                const playerChips = teamContainer.querySelectorAll('.player-chip');
                if (playerChips.length < 2) {
                    const chip = document.createElement('div');
                    chip.className = 'player-chip';
                    chip.dataset.playerId = playerId;
                    chip.innerHTML = `
                        <div class="player-chip-content">
                            <span class="player-chip-name">${player.name}</span>
                            <span class="skill-badge">Lvl ${player.skillLevel}</span>
                        </div>
                        <button class="chip-action remove" data-action="remove-queue-player" title="Remove player">‚úï</button>
                    `;
                    
                    // Add remove handler
                    chip.querySelector('[data-action="remove-queue-player"]').addEventListener('click', () => {
                        chip.remove();
                        this.updateQueueDialogEmptySlots(teamNumber);
                    });
                    
                    teamContainer.appendChild(chip);
                }

                // Update empty slots
                this.updateQueueDialogEmptySlots(teamNumber);
            }

            updateQueueDialogEmptySlots(teamNumber) {
                const dialog = this.elements.queueMatchDialog;
                const teamContainer = dialog.querySelector(`.team[data-team="${teamNumber}"] .team-players`);
                const playerChips = teamContainer.querySelectorAll('.player-chip');
                
                // Clear existing empty slots
                teamContainer.querySelectorAll('.empty-slot').forEach(slot => slot.remove());
                
                // Add empty slots if needed
                if (playerChips.length < 2) {
                    const slotsNeeded = 2 - playerChips.length;
                    for (let i = 0; i < slotsNeeded; i++) {
                        const slot = document.createElement('div');
                        slot.className = 'empty-slot';
                        slot.dataset.action = 'add-queue-player';
                        slot.innerHTML = '<span>Add player</span>';
                        teamContainer.appendChild(slot);
                    }
                }
            }

            updateQueuePreview(court) {
                const queuePreview = this.elements.queueMatchDialog.querySelector('.queue-preview');
                queuePreview.innerHTML = this.renderQueueList(court);
            }

            addPlayerToGameTeam(courtId, teamNumber, playerId) {
                const court = this.courtManager.courts.get(courtId);
                const game = court.currentGame;
                
                // Check if player is already in any team
                const isInTeam1 = game.team1.players.has(playerId);
                const isInTeam2 = game.team2.players.has(playerId);
                
                if (!isInTeam1 && !isInTeam2) {
                    if (this.courtManager.addPlayerToGame(courtId, teamNumber, playerId)) {
                        this.playerManager.updatePlayerStatus(playerId, 'playing', true);
                        this.renderCourts();
                    }
                }
            }

            addPlayerToQueueTeam(courtId, teamNumber, playerId) {
                const court = this.courtManager.courts.get(courtId);
                if (!court.queueTeams) {
                    court.queueTeams = [{ team1: [], team2: [] }];
                }
                
                const team = teamNumber === 1 ? court.queueTeams[0].team1 : court.queueTeams[0].team2;
                const otherTeam = teamNumber === 1 ? court.queueTeams[0].team2 : court.queueTeams[0].team1;
                
                // Only check if player is in the current building teams
                if (!team.includes(playerId) && !otherTeam.includes(playerId) && team.length < 2) {
                    team.push(playerId);
                    this.playerManager.updatePlayerStatus(playerId, 'queued', true);
                    
                    // Auto-queue when both teams are complete
                    if (court.queueTeams[0].team1.length === 2 && court.queueTeams[0].team2.length === 2) {
                        const newGame = new Game();
                        court.queueTeams[0].team1.forEach(id => newGame.addPlayer(1, id));
                        court.queueTeams[0].team2.forEach(id => newGame.addPlayer(2, id));
                        if (court.addToQueue(newGame)) {
                            // Queue was successful, reset queueTeams
                            court.queueTeams = [{ team1: [], team2: [] }];
                        }
                    }
                    
                    this.renderCourts();
                }
            }

            initialize() {
                this.initializeElements();
                this.setupEventListeners();
                this.setupPlayerManagerListeners();
                this.setupCourtManagerListeners();
                this.setupMobileMenu(); // Add this line
                
                // Initial render
                this.renderPlayersList();
                this.renderCourts();
            }

            setupQueueManagerListeners() {
                this.queueManager.addListener(() => {
                    const queueContainer = document.querySelector('.unified-queue-section');
                    if (queueContainer) {
                        queueContainer.innerHTML = `
                            <div class="section-header">
                                <h2>Queue Management</h2>
                                <button class="button" data-action="add-to-queue">Add New Match</button>
                            </div>
                            <div class="queue-container">
                                <div class="building-match">
                                    ${this.renderBuildingMatch()}
                                </div>
                                <div class="queue-list" id="queueList">
                                    ${this.renderQueueEntries()}
                                </div>
                            </div>
                        `;
                    }
                });
            }

            setupDragAndDrop() {
                const queueList = document.getElementById('queueList');
                if (!queueList) return;

                queueList.addEventListener('dragstart', (e) => {
                    const entry = e.target.closest('.queue-entry');
                    if (entry) {
                        entry.classList.add('dragging');
                        e.dataTransfer.setData('text/plain', entry.dataset.entryId);
                    }
                });

                queueList.addEventListener('dragend', (e) => {
                    const entry = e.target.closest('.queue-entry');
                    if (entry) {
                        entry.classList.remove('dragging');
                    }
                });

                queueList.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const draggingEntry = queueList.querySelector('.dragging');
                    if (!draggingEntry) return;

                    const entries = [...queueList.querySelectorAll('.queue-entry:not(.dragging)')];
                    const afterElement = this.getDragAfterElement(queueList, e.clientY);
                    
                    if (afterElement) {
                        const fromIndex = Array.from(queueList.children).indexOf(draggingEntry);
                        const toIndex = Array.from(queueList.children).indexOf(afterElement);
                        this.queueManager.moveEntry(fromIndex, toIndex);
                    }
                });
            }

            removeQueueEntry(entryId) {
                if (confirm('Are you sure you want to remove this match from the queue?')) {
                    this.queueManager.removeFromQueue(entryId);
                }
            }

            getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.queue-entry:not(.dragging)')];
                
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            renderQueueEntries() {
                const queue = this.queueManager.queue;
                if (queue.length === 0) {
                    return `
                        <div class="empty-state">
                            <p>No matches in queue</p>
                        </div>
                    `;
                }

                return `
                    <div class="queue-entries">
                        ${queue.map((entry, index) => this.renderQueueEntry(entry, index)).join('')}
                    </div>
                `;
            }

            renderSidebar() {
                return `
                    <div class="sidebar-header">
                        <div class="sidebar-title">
                            <h2>Players</h2>
                            <button class="button" id="addPlayersBtn">Add Players</button>
                        </div>
                        <div class="search-box">
                            <input type="text" placeholder="Search players...">
                        </div>
                    </div>
                    <div class="players-list" id="playersList">
                        ${this.renderPlayersList()}
                    </div>
                `;
            }

            // Add this helper method to UIManager
            getPlayerStatusText(statusSet) {
                const statusMessages = [];
                if (statusSet.has('playing')) statusMessages.push('Currently in a game');
                if (statusSet.has('queued')) statusMessages.push('In queue');
                if (statusSet.has('resting')) statusMessages.push('Taking a break');
                if (statusSet.has('ready')) statusMessages.push('Ready to play');
                if (statusSet.has('waiting')) statusMessages.push('Available to play');
                
                return statusMessages.length > 0 ? statusMessages.join(' ‚Ä¢ ') : 'Available';
            }

            // Add this after the existing setupEventListeners method in UIManager class
            setupMobileMenu() {
                const mobileMenuBtn = document.querySelector('.mobile-menu-button');
                const sidebar = document.querySelector('.sidebar');
                
                // Create overlay element
                const overlay = document.createElement('div');
                overlay.className = 'sidebar-overlay';
                document.body.appendChild(overlay);

                // Toggle sidebar
                mobileMenuBtn.addEventListener('click', () => {
                    sidebar.classList.add('active');
                    overlay.classList.add('active');
                });

                // Close sidebar when clicking overlay
                overlay.addEventListener('click', () => {
                    sidebar.classList.remove('active');
                    overlay.classList.remove('active');
                });

                // Add swipe to close
                let touchStartX = 0;
                let touchEndX = 0;

                sidebar.addEventListener('touchstart', (e) => {
                    touchStartX = e.changedTouches[0].screenX;
                }, false);

                sidebar.addEventListener('touchend', (e) => {
                    touchEndX = e.changedTouches[0].screenX;
                    if (touchStartX - touchEndX > 50) { // Swipe left
                        sidebar.classList.remove('active');
                        overlay.classList.remove('active');
                    }
                }, false);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize managers
            const playerManager = new PlayerManager();
            const queueManager = new QueueManager(playerManager);
            const courtManager = new CourtManager(playerManager);
            const uiManager = new UIManager(playerManager, courtManager, queueManager);

            // Try to load saved state
            const stateLoaded = PersistenceManager.loadState(playerManager, courtManager, queueManager);

            // If no state was loaded, initialize with default data
            if (!stateLoaded) {
                // Add initial courts
                courtManager.createCourt();
                courtManager.createCourt();

                // Add default players
                playerManager.bulkAddPlayers([
                    { name: 'Reena', skillLevel: 4 },
                    { name: 'Tristan', skillLevel: 4 },
                    { name: 'Jamie', skillLevel: 4 },
                    { name: 'JB', skillLevel: 4 },
                    { name: 'Alexis', skillLevel: 4 },
                    { name: 'Jetson', skillLevel: 4 },
                    { name: 'Buy', skillLevel: 4 },
                    { name: 'Michael', skillLevel: 4 },
                    { name: 'Aiesha', skillLevel: 4 },
                    { name: 'Mory', skillLevel: 4 },
                    { name: 'Ken', skillLevel: 4 },
                    { name: 'Darryl', skillLevel: 4 },
                    { name: 'Pat', skillLevel: 4 },
                    { name: 'Jonah', skillLevel: 4 }
                ]);
            }

            // Initialize the UI
            uiManager.initialize();

            // Set up auto-save
            const autoSave = () => {
                PersistenceManager.saveState(playerManager, courtManager, queueManager);
            };

            // Save state on important actions
            playerManager.addListener(() => autoSave());
            courtManager.addListener(() => autoSave());
            queueManager.addListener(() => autoSave());

            // Save state before page unload
            window.addEventListener('beforeunload', () => {
                autoSave();
            });
        });

        class QueueManager {
            constructor(playerManager) {
                this.playerManager = playerManager;
                this.queue = [];  // Array of matches: { team1: [playerIds], team2: [playerIds], createdAt }
                this.listeners = new Set();
            }

            addMatch(team1Players, team2Players) {
                this.queue.push({
                    team1: team1Players,
                    team2: team2Players,
                    createdAt: Date.now()
                });
                this.notifyListeners();
            }

            removeMatch(index) {
                this.queue.splice(index, 1);
                this.notifyListeners();
            }

            moveMatch(fromIndex, toIndex) {
                const [match] = this.queue.splice(fromIndex, 1);
                this.queue.splice(toIndex, 0, match);
                this.notifyListeners();
            }

            addListener(callback) {
                this.listeners.add(callback);
            }

            notifyListeners() {
                this.listeners.forEach(callback => callback());
            }
        }

        // Add this class after the QueueManager class and before the document.addEventListener('DOMContentLoaded')

        class PersistenceManager {
            static STORAGE_KEYS = {
                PLAYERS: 'badminton_players',
                COURTS: 'badminton_courts',
                QUEUE: 'badminton_queue',
                LAST_COURT_ID: 'badminton_last_court_id'
            };

            static saveState(playerManager, courtManager, queueManager) {
                // Save players
                const players = Array.from(playerManager.players.entries()).map(([id, player]) => ({
                    id,
                    name: player.name,
                    skillLevel: player.skillLevel,
                    status: Array.from(player.status),
                    gamesPlayed: player.gamesPlayed
                }));
                localStorage.setItem(this.STORAGE_KEYS.PLAYERS, JSON.stringify(players));

                // Save courts
                const courts = Array.from(courtManager.courts.entries()).map(([id, court]) => ({
                    id,
                    name: court.name,
                    currentGame: {
                        team1: Array.from(court.currentGame.team1.players),
                        team2: Array.from(court.currentGame.team2.players),
                        startTime: court.currentGame.startTime,
                        elapsedTime: court.currentGame.elapsedTime,
                        status: court.currentGame.status
                    },
                    queue: court.queue.map(game => ({
                        team1: Array.from(game.team1.players),
                        team2: Array.from(game.team2.players)
                    })),
                    queueTeams: court.queueTeams
                }));
                localStorage.setItem(this.STORAGE_KEYS.COURTS, JSON.stringify(courts));

                // Save last court ID
                localStorage.setItem(this.STORAGE_KEYS.LAST_COURT_ID, courtManager.nextCourtId);

                // Save queue
                localStorage.setItem(this.STORAGE_KEYS.QUEUE, JSON.stringify(queueManager.queue));
            }

            static loadState(playerManager, courtManager, queueManager) {
                try {
                    // Load players
                    const playersData = JSON.parse(localStorage.getItem(this.STORAGE_KEYS.PLAYERS) || '[]');
                    playerManager.players.clear();
                    playersData.forEach(playerData => {
                        const player = new Player(playerData.id, playerData.name, playerData.skillLevel);
                        player.status = new Set(playerData.status);
                        player.gamesPlayed = playerData.gamesPlayed || 0;
                        playerManager.players.set(player.id, player);
                    });

                    // Load courts
                    const courtsData = JSON.parse(localStorage.getItem(this.STORAGE_KEYS.COURTS) || '[]');
                    courtManager.courts.clear();
                    courtsData.forEach(courtData => {
                        const court = new Court(courtData.id, courtData.name);
                        
                        // Restore current game
                        if (courtData.currentGame) {
                            courtData.currentGame.team1.forEach(playerId => 
                                court.currentGame.addPlayer(1, playerId));
                            courtData.currentGame.team2.forEach(playerId => 
                                court.currentGame.addPlayer(2, playerId));
                            
                            // Restore game state
                            court.currentGame.status = courtData.currentGame.status;
                            if (court.currentGame.status === 'active') {
                                court.currentGame.startTime = courtData.currentGame.startTime;
                                // Set up timer update callback
                                court.currentGame.setTimerUpdateCallback((elapsedTime) => {
                                    courtManager.notifyListeners('timer', { courtId: court.id, elapsedTime });
                                });
                                // Start the timer
                                court.currentGame.startTimer();
                            }
                        }

                        // Restore queue
                        court.queue = courtData.queue.map(gameData => {
                            const game = new Game();
                            gameData.team1.forEach(playerId => game.addPlayer(1, playerId));
                            gameData.team2.forEach(playerId => game.addPlayer(2, playerId));
                            return game;
                        });

                        // Restore queue teams
                        court.queueTeams = courtData.queueTeams || [{ team1: [], team2: [] }];

                        courtManager.courts.set(court.id, court);
                    });

                    // Restore last court ID
                    courtManager.nextCourtId = parseInt(localStorage.getItem(this.STORAGE_KEYS.LAST_COURT_ID) || '1');

                    // Load queue
                    const queueData = JSON.parse(localStorage.getItem(this.STORAGE_KEYS.QUEUE) || '[]');
                    queueManager.queue = queueData;

                    return true;
                } catch (error) {
                    console.error('Error loading state:', error);
                    return false;
                }
            }

            static clearState() {
                Object.values(this.STORAGE_KEYS).forEach(key => {
                    localStorage.removeItem(key);
                });
            }
        }

        // Add this code right after the opening <script> tag

        // Version control system
        class VersionControl {
            static VERSION = '1.0.0';
            static STORAGE_KEY = 'badminton_app_version';

            static checkVersion() {
                const storedVersion = localStorage.getItem(this.STORAGE_KEY);
                
                if (storedVersion !== this.VERSION) {
                    // Show update message
                    document.body.innerHTML = `
                        <div style="
                            position: fixed;
                            top: 0;
                            left: 0;
                            right: 0;
                            bottom: 0;
                            background: white;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                        ">
                            <h2>Updating App...</h2>
                            <p>Please wait while we get the latest version ready.</p>
                            <div style="
                                width: 50px;
                                height: 50px;
                                border: 3px solid #f3f3f3;
                                border-top: 3px solid #3498db;
                                border-radius: 50%;
                                animation: spin 1s linear infinite;
                            "></div>
                        </div>
                        <style>
                            @keyframes spin {
                                0% { transform: rotate(0deg); }
                                100% { transform: rotate(360deg); }
                            }
                        </style>
                    `;

                    // Clear cache and reload
                    localStorage.clear();
                    localStorage.setItem(this.STORAGE_KEY, this.VERSION);
                    
                    // Force reload after a short delay to show the message
                    setTimeout(() => {
                        window.location.reload(true);
                        if (caches) {
                            caches.keys().then(names => {
                                names.forEach(name => {
                                    caches.delete(name);
                                });
                            });
                        }
                    }, 1000);
                    
                    return false;
                }
                return true;
            }
        }

        // Add version check to the DOMContentLoaded event
        document.addEventListener('DOMContentLoaded', () => {
            // Check version before initializing app
            if (!VersionControl.checkVersion()) {
                return; // Stop initialization if version check triggered a reload
            }

            // Rest of your initialization code...
            const playerManager = new PlayerManager();
            const queueManager = new QueueManager(playerManager);
            // ...
        });
    </script>

    <!-- Update the queue match dialog HTML -->
    <dialog id="queueMatchDialog" class="dialog">
        <div class="dialog-header">
            <h2>Add Match to Queue</h2>
        </div>
        <div class="dialog-content">
            <div class="game-section">
                <div class="section-header">
                    <h3>New Match</h3>
                </div>
                <div class="teams-container">
                    <div class="team" data-team="1">
                        <div class="team-header">
                            <h4>Team 1</h4>
                        </div>
                        <div class="team-players">
                            <div class="empty-slot" data-action="add-queue-player">
                                <span>Add player</span>
                            </div>
                            <div class="empty-slot" data-action="add-queue-player">
                                <span>Add player</span>
                            </div>
                        </div>
                    </div>
                    <div class="vs-badge">VS</div>
                    <div class="team" data-team="2">
                        <div class="team-header">
                            <h4>Team 2</h4>
                        </div>
                        <div class="team-players">
                            <div class="empty-slot" data-action="add-queue-player">
                                <span>Add player</span>
                            </div>
                            <div class="empty-slot" data-action="add-queue-player">
                                <span>Add player</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="queue-section">
                <div class="section-header">
                    <h3>Current Queue</h3>
                </div>
                <div class="queue-preview">
                    <!-- Queue will be rendered here -->
                </div>
            </div>
        </div>
        <div class="dialog-actions">
            <button type="button" class="button secondary" id="cancelQueueMatch">Cancel</button>
            <button type="button" class="button" id="confirmQueueMatch">Add to Queue</button>
        </div>
    </dialog>
</body>
</html>
