<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queue Master</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap">
    <style>
        :root {
            /* System fonts with Inter as webfont fallback */
            --font-primary: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
            
            /* Spacing scale */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;

            /* Colors */
            --color-primary: #007AFF;
            --color-background: #FFFFFF;
            --color-surface: #F5F7FA;
            --color-text: #1C1C1E;
            --color-text-secondary: #6C6C70;
            --color-border: #E5E5EA;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            
            /* New variables */
            --color-success: #12b886;
            --color-success-light: #ebfbee;
            --color-warning: #fab005;
            --color-error: #fa5252;
            --color-info: #228be6;
            
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            
            /* Animation curves */
            --bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
            box-sizing: border-box;

            /* Add these scrollbar styles */
            --scrollbar-width: 8px;
            --scrollbar-track: var(--color-surface);
            --scrollbar-thumb: #CBD5E0;
        }

        *, *:before, *:after {
            box-sizing: inherit;
        }

        body {
            font-family: var(--font-primary);
            background: var(--color-background);
            color: var(--color-text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
        }
        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }
        .player-pool {
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
        }
        .player-pool h2 {
            padding: var(--spacing-md);
            margin: 0;
        }
        .player-pool-controls {
            padding: var(--spacing-md);
            background: #fff;
            border-bottom: 1px solid var(--color-border);
        }
        .filter-section {
            margin-bottom: var(--spacing-md);
        }
        .filter-section:last-child {
            margin-bottom: 0;
        }
        .filter-label {
            font-size: 0.9em;
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-xs);
            display: block;
        }
        .filter-chips {
            display: flex;
            gap: var(--spacing-xs);
            flex-wrap: wrap;
            margin-bottom: var(--spacing-sm);
        }
        .filter-chip {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.85em;
            cursor: pointer;
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            transition: all 0.2s ease;
        }
        .filter-chip:hover {
            border-color: var(--color-primary);
        }
        .filter-chip.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }
        .search-box {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.2s ease;
        }
        .search-box:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        #availablePlayers {
            padding: var(--spacing-md);
        }
        .court {
            background: var(--color-surface);
            padding: var(--spacing-md);
            margin: var(--spacing-md) 0;
            border-radius: 8px;
            min-height: 100px;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .court-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .finish-game-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 0.9em;
        }
        .finish-game-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .game-result-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
            backdrop-filter: blur(2px);
        }
        .player-card {
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: var(--spacing-md);
            margin: var(--spacing-sm) 0;
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
            position: relative;
            cursor: grab;
        }
        .player-card:not(.in-game) {
            transition: all 0.2s ease;
        }
        .player-card.dragging {
            opacity: 0.5;
            transform: scale(1.02);
            cursor: grabbing;
        }
        .player-card.in-game {
            cursor: not-allowed;
            opacity: 0.9;
            background: var(--color-surface);
        }
        .player-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        .player-card.in-game:hover {
            transform: none;
            box-shadow: var(--shadow-sm);
        }
        .player-card.in-game .player-card-actions,
        .player-card.in-game .edit-hint,
        .player-card.in-game .delete-btn {
            display: none;
        }
        .player-stats {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        .court.dragover {
            transform: scale(1.01);
            border: 2px dashed var(--color-primary);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
            background: var(--color-success-light);
            transition: all 0.2s var(--bounce);
        }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            cursor: pointer;
        }
        .game-history {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .history-entry {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        .sort-filter-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .timer {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        .timer.warning {
            color: #f03e3e;
            font-weight: bold;
        }
        .search-box {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }
        .court-controls {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .start-game-btn {
            background: #228be6;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 0.9em;
        }
        .start-game-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .footer {
            margin-top: 40px;
            padding: 20px;
            text-align: center;
            border-top: 1px solid #dee2e6;
            color: #6c757d;
        }
        .footer a {
            color: #228be6;
            text-decoration: none;
        }
        .footer a:hover {
            text-decoration: underline;
        }
        
        /* Add responsive styles */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .player-pool {
            }

            .court-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .court-controls {
                width: 100%;
            }

            .start-game-btn,
            .finish-game-btn {
                width: 100%;
                padding: 12px;
                margin: 5px 0;
            }

            .player-card {
                padding: var(--spacing-lg);
                margin: var(--spacing-md) 0;
            }

            .player-card:active {
                transform: scale(0.98);
                background: var(--color-surface);
            }

            .sort-filter-options {
                flex-direction: column;
                width: 100%;
            }

            .sort-filter-options select {
                width: 100%;
                padding: 8px;
            }

            .game-result-dialog {
                width: 90%;
                max-width: none;
                padding: 15px;
            }

            .controls {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .controls button {
                width: 100%;
                padding: 12px;
            }

            h1 {
                font-size: 1.5em;
                text-align: center;
            }

            h2 {
                font-size: 1.2em;
            }

            .timer {
                font-size: 1em;
                text-align: center;
                width: 100%;
                background: #f8f9fa;
                padding: 5px;
                border-radius: 4px;
            }
        }

        /* Add touch-friendly styles */
        @media (hover: none) {
            .player-card {
                cursor: grab;
                touch-action: none;
                user-select: none;
                -webkit-user-select: none;
            }

            .player-card:active {
                background: #e9ecef;
                transform: scale(0.98);
            }

            .court.dragover {
                border: 3px dashed #339af0;
            }
        }

        /* Improve dialog on mobile */
        .game-result-dialog {
            max-height: 90vh;
            overflow-y: auto;
        }

        .game-result-dialog input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }

        .game-result-dialog label {
            display: inline-flex;
            align-items: center;
            padding: 10px 0;
        }

        .edit-player-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
            width: 90%;
            max-width: 400px;
        }
        .player-card-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        .edit-btn {
            background: #228be6;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.8em;
            cursor: pointer;
        }
        .delete-btn {
            background: #fa5252;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.8em;
            cursor: pointer;
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }

        .toast {
            padding: 12px 24px;
            border-radius: 8px;
            margin: 8px;
            color: white;
            animation: slideIn 0.3s var(--bounce);
            box-shadow: var(--shadow-md);
        }

        .toast-success { background: var(--color-success); }
        .toast-error { background: var(--color-error); }
        .toast-info { background: var(--color-info); }

        /* Empty states */
        .empty-state {
            text-align: center;
            padding: var(--spacing-lg);
            background: var(--color-surface);
            border-radius: 8px;
            margin: var(--spacing-md);
        }

        .empty-state img {
            width: 120px;
            height: 120px;
            margin-bottom: var(--spacing-md);
            opacity: 0.8;
        }

        .empty-state h3 {
            color: var(--color-text);
            margin-bottom: var(--spacing-sm);
        }

        .empty-state p {
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-lg);
        }

        /* Status pills */
        .status-pill {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .status-pill.active {
            background: var(--color-success-light);
            color: var(--color-success);
        }

        .status-pill.waiting {
            background: var(--color-surface);
            color: var(--color-text-secondary);
        }

        /* Enhanced court styling */
        .court {
            transition: all 0.2s var(--bounce);
        }

        .court.can-drop {
            background: var(--color-success-light);
            border: 2px dashed var(--color-success);
            transform: scale(1.02);
        }

        /* Player card enhancements */
        .player-card {
            transform-origin: center;
            transition: all 0.2s var(--bounce);
        }

        .player-card[dragging="true"] {
            transform: scale(1.05) rotate(2deg);
            box-shadow: var(--shadow-lg);
            opacity: 0.9;
        }

        /* Modern dialog styling */
        .modal, .player-search-modal {
            box-sizing: border-box;
            background: var(--color-background);
            border-radius: 16px;
            padding: var(--spacing-xl);
            width: min(500px, 95%);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            overflow-y: auto;
            max-height: min(600px, 80vh);
            transition: transform 0.3s var(--bounce), opacity 0.2s ease;
            opacity: 0;
            transform: translate(-50%, -48%);
        }

        .modal[style*="display: block"], 
        .player-search-modal[style*="display: block"] {
            opacity: 1;
            transform: translate(-50%, -50%);
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-sm);
            color: var(--color-text);
            font-weight: 500;
            font-size: 1em;
        }

        .level-selector {
            box-sizing: border-box;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-xs);
            margin-top: var(--spacing-sm);
            width: 100%;
        }

        .level-option {
            padding: var(--spacing-sm);
            background: white;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .level-option h4 {
            margin: 0 0 var(--spacing-xs) 0;
            font-size: 1em;
        }

        .level-option p {
            margin: 0;
            font-size: 0.9em;
            color: var(--color-text-secondary);
        }

        .level-option:hover {
            border-color: var(--color-primary);
            background: white;
        }

        .level-option.selected {
            border-color: var(--color-primary);
            background: var(--color-primary);
            color: white;
        }

        .level-option.selected p {
            color: rgba(255, 255, 255, 0.9);
        }

        /* Game results styling */
        .game-results {
            padding: var(--spacing-md);
            max-width: 500px;
        }

        .game-duration {
            text-align: center;
            color: var(--color-text-secondary);
            font-size: 1.1em;
            margin-bottom: var(--spacing-md);
        }

        .player-result-cards {
            display: grid;
            gap: var(--spacing-md);
            margin: var(--spacing-lg) 0;
        }

        .player-result-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md);
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s var(--bounce);
        }

        .player-result-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .player-result-card.selected {
            background: var(--color-success-light);
            border-color: var(--color-success);
        }

        .player-result-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .player-result-name {
            font-weight: 500;
            font-size: 1.1em;
        }

        .player-result-level {
            font-size: 0.9em;
            color: var(--color-text-secondary);
        }

        .winner-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--color-text-secondary);
            opacity: 0.5;
            transition: all 0.2s ease;
        }

        .player-result-card.selected .winner-indicator {
            color: var(--color-success);
            opacity: 1;
        }

        .checkmark {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--color-surface);
            border: 2px solid currentColor;
        }

        .player-result-card.selected .checkmark {
            background: var(--color-success);
            color: white;
            border-color: var(--color-success);
        }

        .result-actions {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        .submit-results,
        .cancel-results {
            flex: 1;
            padding: var(--spacing-md);
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .submit-results {
            background: var(--color-success);
            color: white;
        }

        .submit-results:hover {
            background: #0ca678;
        }

        .cancel-results {
            background: var(--color-surface);
            color: var(--color-text);
        }

        .cancel-results:hover {
            background: #e9ecef;
        }

        /* Keyboard shortcut hints */
        .shortcut-hint {
            position: absolute;
            right: var(--spacing-sm);
            bottom: var(--spacing-sm);
            font-size: 0.8em;
            color: var(--color-text-secondary);
            background: var(--color-surface);
            padding: 2px 6px;
            border-radius: 4px;
            opacity: 0.8;
        }

        /* Touch gesture hints */
        @media (hover: none) {
            .gesture-hint {
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 0.9em;
                pointer-events: none;
                opacity: 0;
                transition: opacity 0.3s ease;
            }

            .gesture-hint.visible {
                opacity: 1;
            }
        }

        .player-card {
            position: relative;
            padding: var(--spacing-md);
        }

        .editable-text {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .editable-text:hover {
            background: var(--color-surface);
        }

        .edit-hint {
            opacity: 0;
            font-size: 0.8em;
            margin-left: 4px;
            color: var(--color-text-secondary);
            transition: opacity 0.2s ease;
        }

        .player-name:hover .edit-hint,
        .player-level:hover .edit-hint {
            opacity: 1;
        }

        .inline-edit-name,
        .inline-edit-level {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-size: 1em;
        }

        .inline-edit-actions {
            display: flex;
            gap: 8px;
        }

        .save-btn,
        .cancel-btn {
            padding: 4px 8px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
        }

        .save-btn {
            background: var(--color-success);
            color: white;
        }

        .cancel-btn {
            background: var(--color-surface);
            color: var(--color-text);
        }

        .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: transparent;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .player-card:hover .delete-btn {
            opacity: 1;
        }

        .delete-icon {
            font-size: 1.2em;
        }

        /* Add these new styles after existing styles */
        .court-add-player {
            width: 95%;
            margin: var(--spacing-md) auto;
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--color-info);
            color: white;
            border: none;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s var(--bounce);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            font-weight: 500;
        }

        .court-add-player:hover {
            background: var(--color-primary);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .court-add-player:active {
            transform: translateY(0);
        }

        /* Update the add player button icon and text */
        .court-add-player::before {
            content: "+";
            margin-right: 4px;
        }

        @media (max-width: 768px) {
            .court-add-player {
                padding: var(--spacing-md);
            }
        }

        .player-search-results {
            margin-top: var(--spacing-md);
        }

        .search-result-item {
            padding: var(--spacing-sm);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .search-result-item:hover {
            background: var(--color-surface);
        }

        /* Improve mobile court styling */
        @media (max-width: 768px) {
            .court {
                padding: var(--spacing-lg);
                margin-bottom: var(--spacing-lg);
            }

            .player-search-modal {
                padding: var(--spacing-md);
            }
        }

        /* Update the player cards container to allow for the add button */
        .court .player-cards {
            flex: 1;
            min-height: 50px; /* Ensure minimum height even when empty */
        }

        /* Add/update these styles */
        .form-group input[type="text"] {
            box-sizing: border-box;
            width: 100%;
            padding: var(--spacing-md);
            font-size: 1.1em;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            transition: all 0.2s ease;
            background: white;
        }

        .form-group input[type="text"]:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .form-group input[type="text"]::placeholder {
            color: var(--color-text-secondary);
            opacity: 0.7;
        }

        /* Update the form-group spacing */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        /* Update the modal form */
        .modal form {
            margin-top: var(--spacing-md);
        }

        /* Update the form actions */
        .form-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-xl);
        }

        .form-actions button {
            flex: 1;
            padding: var(--spacing-md);
            font-size: 1em;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .form-actions button[type="submit"] {
            background: var(--color-primary);
            color: white;
        }

        .form-actions button[type="submit"]:hover {
            background: #0056b3;
        }

        .form-actions button[type="button"] {
            background: var(--color-surface);
            color: var(--color-text);
        }

        .form-actions button[type="button"]:hover {
            background: #e9ecef;
        }

        /* Add these styles */
        .bulk-textarea {
            width: 100%;
            padding: var(--spacing-md);
            font-size: 1em;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            resize: vertical;
            font-family: var(--font-primary);
            background: white;
        }

        .bulk-textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .bulk-instructions {
            color: var(--color-text-secondary);
            margin-bottom: var(--spacing-md);
            font-size: 0.9em;
        }

        .bulk-level-select {
            width: 100%;
            padding: var(--spacing-sm);
            border: 2px solid var(--color-border);
            border-radius: 8px;
            font-size: 1em;
            background: white;
        }

        .bulk-level-select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        /* Add these styles */
        .modal-close {
            position: absolute;
            top: var(--spacing-md);
            right: var(--spacing-md);
            background: transparent;
            border: none;
            color: var(--color-text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: var(--spacing-xs);
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            color: var(--color-text);
            transform: scale(1.1);
        }

        /* Make courts container scrollable too */
        .courts-container {
        }

        .courts-container h2 {
            position: sticky;
            top: 0;
            background: var(--color-background);
            padding: var(--spacing-md) 0;
            margin: 0;
            z-index: 1;
        }

        /* Scrollbar styling */
        .player-pool #availablePlayers,
        .courts-container {
            padding-right: var(--spacing-md);
        }

        /* Add/update these styles */
        .bottom-nav {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: var(--spacing-md);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .bottom-nav-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
        }

        .bottom-nav button {
            width: 100%;
            margin: 0;
            padding: var(--spacing-md);
            border: none;
            background: var(--color-surface);
            color: var(--color-text);
            border-radius: 8px;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 0.9em;
        }

        .bottom-nav button::before {
            font-size: 1.2em;
            margin-bottom: 2px;
        }

        .bottom-nav button:nth-child(1)::before { content: "+" }
        .bottom-nav button:nth-child(2)::before { content: "⫘" }
        .bottom-nav button:nth-child(3)::before { content: "◷" }

        .bottom-nav button.active {
            background: var(--color-primary);
            color: white;
        }

        /* Update mobile styles */
        @media (max-width: 768px) {
            body {
                padding-bottom: 80px;
            }

            .container {
                grid-template-columns: 1fr;
            }

            .courts-container {
            }

            .bottom-nav {
                display: block;
            }

            .player-pool {
            }
        }

        /* Status Tags */
        .status-tag {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
        }

        .status-tag::before {
            content: "";
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 4px;
        }

        /* Active Game Status */
        .status-tag.in-game {
            background: var(--color-success-light);
            color: var(--color-success);
        }

        .status-tag.in-game::before {
            background: var(--color-success);
        }

        /* Waiting Status */
        .status-tag.waiting {
            background: #fff3bf;
            color: #fab005;
        }

        .status-tag.waiting::before {
            background: #fab005;
        }

        /* Resting Status */
        .status-tag.resting {
            background: #e3fafc;
            color: #15aabf;
        }

        .status-tag.resting::before {
            background: #15aabf;
        }

        /* Inactive Status */
        .status-tag.inactive {
            background: #f1f3f5;
            color: #adb5bd;
        }

        .status-tag.inactive::before {
            background: #adb5bd;
        }

        /* Game Count Indicator */
        .game-dots {
            display: flex;
            gap: 3px;
            margin-top: 6px;
            flex-wrap: wrap;
        }

        .game-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--color-border);
        }

        /* Win/Loss colors */
        .game-dot.win {
            background: var(--color-success);
        }

        .game-dot.loss {
            background: var(--color-error);
        }

        /* Max dots to show before condensing */
        .game-count-overflow {
            font-size: 0.75em;
            color: var(--color-text-secondary);
            margin-left: 4px;
            align-self: center;
        }

        /* Update player stats container */
        .player-stats {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .player-stats-text {
            font-size: 0.85em;
            color: var(--color-text-secondary);
        }

        /* Add this to ensure child elements don't interfere with drag events */
        .court * {
            pointer-events: none;
        }

        /* Re-enable pointer events for interactive elements */
        .court button,
        .court .court-add-player,
        .court input,
        .court select {
            pointer-events: auto;
        }

        /* Add a subtle animation to show it's a drop target */
        .court:not(.dragover):hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Add these styles to prevent hidden modals from interfering with drag and drop */
        .modal[style*="display: none"],
        .game-result-dialog[style*="display: none"],
        .player-search-modal[style*="display: none"],
        .dialog-overlay[style*="display: none"] {
            pointer-events: none;
        }

        /* Also ensure visible modals have proper pointer events */
        .modal,
        .game-result-dialog,
        .player-search-modal,
        .dialog-overlay {
            pointer-events: auto;
        }

        /* And ensure the overlay blocks all events when visible */
        .dialog-overlay:not([style*="display: none"]) {
            pointer-events: all;
        }

        /* Add these styles for the count indicators */
        .filter-chip .count {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
            font-size: 0.85em;
        }

        .filter-chip.active .count {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Add these styles for the add player modal level chips */
        .add-player-levels {
            display: grid;
            gap: var(--spacing-sm);
            margin: var(--spacing-md) 0;
        }

        .level-chip {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            border: 2px solid var(--color-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s var(--bounce);
            background: var(--color-surface);
        }

        .level-chip:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .level-chip.selected {
            background: var(--color-success-light);
            border-color: var(--color-success);
        }

        .level-chip-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .level-name {
            font-weight: 500;
            font-size: 1.1em;
        }

        .level-description {
            font-size: 0.9em;
            color: var(--color-text-secondary);
        }

        .level-count {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            color: var(--color-text-secondary);
        }

        .level-chip.selected .level-count {
            background: var(--color-success);
            color: white;
        }

        /* Add these styles for the clear data button and confirmation dialog */
        .danger-zone {
            margin-top: var(--spacing-xl);
            padding: var(--spacing-md);
            border: 1px dashed var(--color-error);
            border-radius: 8px;
            background: #fff5f5;
        }

        .danger-zone h3 {
            color: var(--color-error);
            margin: 0 0 var(--spacing-sm);
            font-size: 1em;
        }

        .clear-data-btn {
            background: var(--color-error);
            color: white;
            border: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        .clear-data-btn:hover {
            background: #e03131;
        }

        .confirm-dialog {
            max-width: 400px;
            text-align: center;
        }

        .confirm-dialog p {
            margin: var(--spacing-md) 0;
            color: var(--color-text-secondary);
        }

        .confirm-actions {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        .confirm-actions button {
            flex: 1;
            padding: var(--spacing-md);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .confirm-delete {
            background: var(--color-error);
            color: white;
        }

        .confirm-delete:hover {
            background: #e03131;
        }

        .confirm-cancel {
            background: var(--color-surface);
            color: var(--color-text);
        }

        .confirm-cancel:hover {
            background: #e9ecef;
        }

        /* Update the modal styles */
        .modal {
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        /* Add styles for the modal content */
        .modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 0 var(--spacing-md);
            margin: var(--spacing-md) 0;
        }

        /* Update form actions to stay at bottom */
        .form-actions {
            position: sticky;
            bottom: 0;
            background: white;
            padding: var(--spacing-md);
            border-top: 1px solid var(--color-border);
            margin: 0 calc(-1 * var(--spacing-md));
            z-index: 2;
        }

        /* Update level chip styles */
        .level-chip {
            position: relative;
        }

        .level-chip::after {
            content: '';
            position: absolute;
            inset: 0;
            cursor: pointer;
        }

        /* Add hover state for better feedback */
        .level-chip:not(.selected):hover {
            border-color: var(--color-primary);
            background: var(--color-surface);
        }
    </style>
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
    </script>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <h1>Queue Master</h1>

    <div class="controls">
        <button onclick="addNewPlayer()">
            <span>Add New Player</span>
            <span class="shortcut-hint">A</span>
        </button>
        <button onclick="showBulkAddDialog()">
            <span>Bulk Add Players</span>
            <span class="shortcut-hint">B</span>
        </button>
        <button onclick="showGameHistory()">
            <span>Game History</span>
            <span class="shortcut-hint">H</span>
        </button>
    </div>

    <div class="container">
        <div class="player-pool" ondrop="drop(event)" ondragover="allowDrop(event)">
            <h2>Available Players</h2>
            <div id="playerPoolEmpty" class="empty-state" style="display: none;">
                <img src="https://api.iconify.design/ph:users-three-light.svg" alt="No players">
                <h3>No Players Yet</h3>
                <p>Add players to start managing games</p>
                <button onclick="addNewPlayer()">Add First Player</button>
            </div>
            <div class="player-pool-controls">
                <div class="filter-section">
                    <input type="text" 
                           class="search-box" 
                           id="playerSearch" 
                           placeholder="Search players..."
                           oninput="updateDisplay()">
                </div>
                
                <div class="filter-section">
                    <span class="filter-label">Status</span>
                    <div class="filter-chips" id="statusFilters">
                        <button class="filter-chip active" data-status="all">All</button>
                        <button class="filter-chip" data-status="available">Available</button>
                        <button class="filter-chip" data-status="new">New Players</button>
                        <button class="filter-chip" data-status="resting">Resting</button>
                        <button class="filter-chip" data-status="inactive">Inactive</button>
                    </div>
                </div>

                <div class="filter-section">
                    <span class="filter-label">Level</span>
                    <div class="filter-chips" id="levelFilters">
                        <button class="filter-chip active" data-level="all">All</button>
                        <button class="filter-chip" data-level="1">Beginner</button>
                        <button class="filter-chip" data-level="2">Intermediate</button>
                        <button class="filter-chip" data-level="3">Advanced</button>
                        <button class="filter-chip" data-level="4,5">Expert+</button>
                    </div>
                </div>

                <div class="filter-section">
                    <span class="filter-label">Sort By</span>
                    <div class="filter-chips" id="sortFilters">
                        <button class="filter-chip active" data-sort="waiting">Waiting Longest</button>
                        <button class="filter-chip" data-sort="games-asc">Least Games</button>
                        <button class="filter-chip" data-sort="games-desc">Most Games</button>
                        <button class="filter-chip" data-sort="winrate">Best Win Rate</button>
                    </div>
                </div>
            </div>
            <div id="availablePlayers"></div>
        </div>

        <div class="courts-container">
            <h2>Courts</h2>
            <div id="courts"></div>
        </div>
    </div>

    <div id="gameHistory" class="game-history" style="display: none;">
        <h2>Game History</h2>
        <div id="historyEntries"></div>
    </div>

    <div id="dialogOverlay" class="dialog-overlay"></div>
    <div id="gameResultDialog" class="game-result-dialog">
        <h3>Game Results</h3>
        <div id="gameResultContent"></div>
        <button onclick="submitGameResults()">Submit Results</button>
    </div>

    <div id="editPlayerDialog" class="edit-player-dialog">
        <h3>Edit Player</h3>
        <div>
            <input type="text" id="editPlayerName" placeholder="Player Name" style="width: 100%; margin-bottom: 10px;">
            <select id="editPlayerLevel" style="width: 100%; margin-bottom: 10px;">
                <option value="1">Level 1 - Beginner (Learning the basics)</option>
                <option value="2">Level 2 - Intermediate (Consistent rallies)</option>
                <option value="3">Level 3 - Advanced (Good game control)</option>
                <option value="4">Level 4 - Expert (Strong all-around player)</option>
                <option value="5">Level 5 - Pro (Tournament level)</option>
            </select>
            <button onclick="savePlayerEdit()" style="margin-right: 10px;">Save Changes</button>
            <button onclick="closeEditDialog()">Cancel</button>
        </div>
    </div>

    <div id="addPlayerDialog" class="modal" style="display: none;">
        <button class="modal-close" onclick="closeAddPlayerDialog()">×</button>
        <h3>Add New Player</h3>
        <form onsubmit="handleAddPlayer(event)">
            <div class="modal-content">
                <div class="form-group">
                    <label for="newPlayerName">Player Name</label>
                    <input 
                        type="text" 
                        id="newPlayerName" 
                        placeholder="Enter player name"
                        required
                        autocomplete="off"
                        autofocus>
                </div>
                <div class="form-group">
                    <label>Skill Level</label>
                    <div class="add-player-levels" id="addPlayerLevels">
                        <div class="level-chip" data-level="1" onclick="selectLevel(1)">
                            <div class="level-chip-content">
                                <span class="level-name">Beginner</span>
                                <span class="level-description">Learning the basics, new to the game</span>
                            </div>
                            <span class="level-count">0</span>
                        </div>
                        <div class="level-chip" data-level="2" onclick="selectLevel(2)">
                            <div class="level-chip-content">
                                <span class="level-name">Intermediate</span>
                                <span class="level-description">Can maintain consistent rallies</span>
                            </div>
                            <span class="level-count">0</span>
                        </div>
                        <div class="level-chip" data-level="3" onclick="selectLevel(3)">
                            <div class="level-chip-content">
                                <span class="level-name">Advanced</span>
                                <span class="level-description">Good game control and strategy</span>
                            </div>
                            <span class="level-count">0</span>
                        </div>
                        <div class="level-chip" data-level="4" onclick="selectLevel(4)">
                            <div class="level-chip-content">
                                <span class="level-name">Expert</span>
                                <span class="level-description">Strong all-around player</span>
                            </div>
                            <span class="level-count">0</span>
                        </div>
                        <div class="level-chip" data-level="5" onclick="selectLevel(5)">
                            <div class="level-chip-content">
                                <span class="level-name">Pro</span>
                                <span class="level-description">Tournament level player</span>
                            </div>
                            <span class="level-count">0</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="submit-btn">Add Player</button>
                <button type="button" class="cancel-btn" onclick="closeAddPlayerDialog()">Cancel</button>
            </div>
        </form>
    </div>

    <div id="playerSearchModal" class="player-search-modal">
        <button class="modal-close" onclick="closePlayerSearch()">×</button>
        <h3>Add Player to Court</h3>
        <input type="text" 
               id="courtPlayerSearch" 
               class="search-box" 
               placeholder="Search players..."
               oninput="searchCourtPlayers()">
        <div id="playerSearchResults" class="player-search-results"></div>
        <button onclick="closePlayerSearch()" style="margin-top: 16px;">Cancel</button>
    </div>

    <div id="bulkAddDialog" class="modal" style="display: none;">
        <button class="modal-close" onclick="closeBulkAddDialog()">×</button>
        <h3>Bulk Add Players</h3>
        <p class="bulk-instructions">Paste a list of names, one per line. Each player will be added as Level 1.</p>
        <form onsubmit="handleBulkAddPlayers(event)">
            <div class="form-group">
                <label for="bulkPlayerNames">Player Names</label>
                <textarea 
                    id="bulkPlayerNames" 
                    placeholder="John Smith
Jane Doe
Mike Johnson"
                    required
                    rows="10"
                    class="bulk-textarea"></textarea>
            </div>
            <div class="form-group">
                <label for="bulkPlayerLevel">Default Level</label>
                <select id="bulkPlayerLevel" class="bulk-level-select">
                    <option value="1">Level 1 - Beginner</option>
                    <option value="2">Level 2 - Intermediate</option>
                    <option value="3">Level 3 - Advanced</option>
                    <option value="4">Level 4 - Expert</option>
                    <option value="5">Level 5 - Pro</option>
                </select>
            </div>
            <div class="form-actions">
                <button type="submit">Add Players</button>
                <button type="button" onclick="closeBulkAddDialog()">Cancel</button>
            </div>
        </form>
    </div>

    <footer class="footer">
        by <a href="https://alexiscollado.com" target="_blank">Alexis Collado</a>
    </footer>

    <div class="bottom-nav">
        <div class="bottom-nav-buttons">
            <button onclick="addNewPlayer()">
                <span>Add Player</span>
            </button>
            <button onclick="showBulkAddDialog()">
                <span>Bulk Add</span>
            </button>
            <button onclick="showGameHistory()">
                <span>History</span>
            </button>
            <button onclick="showCourts()">
                <span>Courts</span>
            </button>
        </div>
    </div>

    <div class="danger-zone">
        <h3>Danger Zone</h3>
        <p>Clear all data including players, games, and history. This action cannot be undone.</p>
        <button class="clear-data-btn" onclick="showClearDataConfirmation()">
            Clear All Data
        </button>
    </div>

    <div id="clearDataDialog" class="modal" style="display: none;">
        <div class="confirm-dialog">
            <h3>Clear All Data?</h3>
            <p>This will permanently delete all players, games, and history. This action cannot be undone.</p>
            <div class="confirm-actions">
                <button class="confirm-delete" onclick="clearAllData()">Yes, Clear Everything</button>
                <button class="confirm-cancel" onclick="closeClearDataDialog()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let players = [];
        let courts = [];
        let gameHistory = [];
        const COURTS_COUNT = 3;
        const GAME_DURATION_WARNING = 20 * 60 * 1000; // 20 minutes in milliseconds

        // Initialize courts with timer properties
        function initializeCourts() {
            courts = Array(COURTS_COUNT).fill().map(() => ({
                players: [],
                startTime: null
            }));
            updateDisplay();
        }

        function getElapsedTime(startTime) {
            if (!startTime) return 'Not started';
            const elapsed = Date.now() - startTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateTimers() {
            courts.forEach((court, i) => {
                if (court.players && court.players.length >= 2) {
                    const timerElement = document.getElementById(`timer-${i}`);
                    if (timerElement) {
                        const elapsedTime = getElapsedTime(court.startTime);
                        timerElement.textContent = elapsedTime;
                        
                        // Add warning class if game is running long
                        if (court.startTime && (Date.now() - court.startTime) > GAME_DURATION_WARNING) {
                            timerElement.classList.add('warning');
                        }
                    }
                }
            });
        }

        // Start timer updates
        setInterval(updateTimers, 1000);

        // Add these variables at the top with other globals
        let activeFilters = {
            status: 'all',
            level: 'all',
            sort: 'waiting'
        };

        // Add this function to handle filter clicks
        function handleFilterClick(event) {
            const chip = event.target;
            if (!chip.classList.contains('filter-chip')) return;
            
            // Update active state in the chip group
            const group = chip.parentElement;
            group.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            chip.classList.add('active');
            
            // Update active filters
            if (group.id === 'statusFilters') activeFilters.status = chip.dataset.status;
            if (group.id === 'levelFilters') activeFilters.level = chip.dataset.level;
            if (group.id === 'sortFilters') activeFilters.sort = chip.dataset.sort;
            
            updateDisplay();
        }

        // Update the sortAndFilterPlayers function
        function sortAndFilterPlayers(players) {
            const searchTerm = document.getElementById('playerSearch').value.toLowerCase();
            
            // Filter players
            let filtered = players.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(searchTerm);
                
                // Status filtering
                if (activeFilters.status !== 'all') {
                    const isInGame = courts.some(court => 
                        court.startTime && court.players.some(cp => cp.id === p.id)
                    );
                    const lastGame = gameHistory
                        .slice()
                        .reverse()
                        .find(game => game.players.some(gp => gp.name === p.name));
                    const timeSinceLastGame = lastGame 
                        ? Date.now() - new Date(lastGame.date).getTime()
                        : null;

                    switch (activeFilters.status) {
                        case 'available':
                            if (isInGame || (timeSinceLastGame && timeSinceLastGame < 10 * 60 * 1000)) return false;
                            break;
                        case 'new':
                            if (p.gamesPlayed > 0) return false;
                            break;
                        case 'resting':
                            if (!timeSinceLastGame || timeSinceLastGame >= 10 * 60 * 1000) return false;
                            break;
                        case 'inactive':
                            if (!timeSinceLastGame || timeSinceLastGame <= 30 * 60 * 1000) return false;
                            break;
                    }
                }

                // Level filtering
                if (activeFilters.level !== 'all') {
                    const levels = activeFilters.level.split(',').map(Number);
                    if (!levels.includes(p.level)) return false;
                }

                return matchesSearch;
            });

            // Sort players
            filtered.sort((a, b) => {
                switch (activeFilters.sort) {
                    case 'waiting':
                        const aLastGame = gameHistory.findLast(g => g.players.some(p => p.name === a.name));
                        const bLastGame = gameHistory.findLast(g => g.players.some(p => p.name === b.name));
                        return (aLastGame?.date || 0) - (bLastGame?.date || 0);
                    case 'games-asc':
                        return a.gamesPlayed - b.gamesPlayed;
                    case 'games-desc':
                        return b.gamesPlayed - a.gamesPlayed;
                    case 'winrate':
                        const aWinRate = a.gamesPlayed ? (a.wins / a.gamesPlayed) : 0;
                        const bWinRate = b.gamesPlayed ? (b.wins / b.gamesPlayed) : 0;
                        return bWinRate - aWinRate;
                }
            });

            return filtered;
        }

        // Add this function to count players for each filter
        function getFilterCounts(players) {
            const counts = {
                status: {
                    all: players.length,
                    available: 0,
                    new: 0,
                    resting: 0,
                    inactive: 0
                },
                level: {
                    all: players.length,
                    1: 0,
                    2: 0,
                    3: 0,
                    '4,5': 0
                }
            };

            players.forEach(p => {
                // Status counts
                const isInGame = courts.some(court => 
                    court.startTime && court.players.some(cp => cp.id === p.id)
                );
                const lastGame = gameHistory
                    .slice()
                    .reverse()
                    .find(game => game.players.some(gp => gp.name === p.name));
                const timeSinceLastGame = lastGame 
                    ? Date.now() - new Date(lastGame.date).getTime()
                    : null;

                if (!isInGame && (!timeSinceLastGame || timeSinceLastGame >= 10 * 60 * 1000)) {
                    counts.status.available++;
                }
                if (p.gamesPlayed === 0) {
                    counts.status.new++;
                }
                if (timeSinceLastGame && timeSinceLastGame < 10 * 60 * 1000) {
                    counts.status.resting++;
                }
                if (timeSinceLastGame && timeSinceLastGame > 30 * 60 * 1000) {
                    counts.status.inactive++;
                }

                // Level counts
                if (p.level <= 3) {
                    counts.level[p.level]++;
                } else {
                    counts.level['4,5']++;
                }
            });

            return counts;
        }

        // Update the updateDisplay function to include counts
        function updateDisplay() {
            const availablePlayers = players.filter(p => 
                !courts.some(court => court.players.some(cp => cp.id === p.id))
            );
            
            // Update filter counts
            const filterCounts = getFilterCounts(availablePlayers);
            
            // Update status filter chips
            document.querySelectorAll('#statusFilters .filter-chip').forEach(chip => {
                const status = chip.dataset.status;
                const count = filterCounts.status[status];
                const countSpan = chip.querySelector('.count') || document.createElement('span');
                countSpan.className = 'count';
                countSpan.textContent = count;
                if (!chip.querySelector('.count')) {
                    chip.appendChild(countSpan);
                }
            });

            // Update level filter chips
            document.querySelectorAll('#levelFilters .filter-chip').forEach(chip => {
                const level = chip.dataset.level;
                const count = filterCounts.level[level];
                const countSpan = chip.querySelector('.count') || document.createElement('span');
                countSpan.className = 'count';
                countSpan.textContent = count;
                if (!chip.querySelector('.count')) {
                    chip.appendChild(countSpan);
                }
            });
            
            const sortedAndFiltered = sortAndFilterPlayers(availablePlayers);
            
            document.getElementById('availablePlayers').innerHTML = 
                sortedAndFiltered.map(createPlayerCard).join('');

            // Update courts
            document.getElementById('courts').innerHTML = courts.map((court, i) => `
                <div class="court" 
                     id="court-${i}" 
                     ondrop="drop(event)" 
                     ondragover="allowDrop(event)"
                     ondragleave="dragLeave(event)">
                    <div class="court-header">
                        <h3>Court ${i + 1} (${court.players.length} players)</h3>
                        <div class="court-controls">
                            <div class="timer" id="timer-${i}">
                                ${court.startTime ? getElapsedTime(court.startTime) : 'Not started'}
                            </div>
                            ${!court.startTime ? `
                                <button 
                                    class="start-game-btn" 
                                    onclick="startGame(${i})"
                                    ${court.players.length < 2 ? 'disabled' : ''}>
                                    Start Game
                                </button>
                            ` : `
                                <button 
                                    class="finish-game-btn" 
                                    onclick="finishCourtGame(${i})">
                                    Finish Game
                                </button>
                            `}
                        </div>
                    </div>
                    <div class="player-cards">
                        ${court.players.map(player => createPlayerCard(player)).join('')}
                    </div>
                    ${court.players.length < 4 && !court.startTime ? `
                        <div class="court-add-player" onclick="showPlayerSearch(${i})">
                            Add Player
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function allowDrop(ev) {
            ev.preventDefault();
            
            // Find the court element
            let courtElement = ev.target;
            while (courtElement && !courtElement.classList.contains('court')) {
                courtElement = courtElement.parentElement;
            }
            
            if (courtElement) {
                const courtIndex = parseInt(courtElement.id.replace('court-', ''));
                const court = courts[courtIndex];
                
                // Only show drop indicator if court is not full and game not started
                if (court && court.players.length < 4 && !court.startTime) {
                    courtElement.classList.add('dragover');
                    courtElement.classList.add('can-drop');
                }
            }
        }

        function drag(ev) {
            const playerId = ev.target.id.replace('player-', '');
            const isInGame = courts.some(court => 
                court.startTime && court.players.some(p => p.id === playerId)
            );
            
            if (isInGame) {
                ev.preventDefault();
                return;
            }
            
            // Add visual feedback for the dragged card
            ev.target.classList.add('dragging');
            ev.dataTransfer.setData("playerId", ev.target.id);
        }

        function dragLeave(ev) {
            let courtElement = ev.target;
            while (courtElement && !courtElement.classList.contains('court')) {
                courtElement = courtElement.parentElement;
            }
            
            if (courtElement) {
                courtElement.classList.remove('dragover');
                courtElement.classList.remove('can-drop');
            }
        }

        function drop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('dragover');
            
            const playerId = ev.dataTransfer.getData("playerId").replace('player-', '');
            const player = players.find(p => p.id === playerId);
            
            // Get court index from the target element
            let courtElement = ev.target;
            while (courtElement && !courtElement.classList.contains('court')) {
                courtElement = courtElement.parentElement;
            }
            
            const courtIndex = courtElement 
                ? parseInt(courtElement.id.replace('court-', ''))
                : null;

            // Remove player from current location (if in a court)
            courts.forEach(court => {
                const playerIndex = court.players.findIndex(p => p.id === playerId);
                if (playerIndex !== -1) {
                    court.players.splice(playerIndex, 1);
                }
            });

            // Add to new court if dropped on a court
            if (courtIndex !== null && !isNaN(courtIndex)) {
                const court = courts[courtIndex];
                // Check if court exists and has space
                if (court && court.players.length < 4 && !court.startTime) {
                    court.players.push(player);
                    showToast(`Added ${player.name} to Court ${courtIndex + 1}`);
                } else if (court.startTime) {
                    showToast('Cannot add player to active game', 'error');
                } else if (court.players.length >= 4) {
                    showToast('Court is full', 'error');
                }
            }

            updateDisplay();
        }

        function startGame(courtIndex) {
            const court = courts[courtIndex];
            if (court.players.length < 2) {
                showToast('Need at least 2 players to start a game!', 'error');
                return;
            }
            
            court.startTime = Date.now();
            showToast('Game started!');
            updateDisplay();
        }

        function finishCourtGame(courtIndex) {
            const court = courts[courtIndex];
            if (!court.startTime) {
                alert('Game has not been started yet!');
                return;
            }
            if (court.players.length < 2) {
                alert('Not enough players to finish a game!');
                return;
            }

            showGameResultDialog(courtIndex);
        }

        function showGameResultDialog(courtIndex) {
            const court = courts[courtIndex];
            const dialog = document.getElementById('gameResultDialog');
            const overlay = document.getElementById('dialogOverlay');
            const content = document.getElementById('gameResultContent');

            content.innerHTML = `
                <div class="game-results">
                    <div class="game-duration">
                        Game Duration: ${getElapsedTime(court.startTime)}
                    </div>
                    <h4>Select Winners</h4>
                    <div class="player-result-cards">
                        ${court.players.map(player => `
                            <div class="player-result-card" 
                                 onclick="toggleWinner('${player.id}')"
                                 data-player-id="${player.id}">
                                <div class="player-result-info">
                                    <span class="player-result-name">${player.name}</span>
                                    <span class="player-result-level">Level ${player.level}</span>
                                </div>
                                <div class="winner-indicator">
                                    <div class="checkmark">✓</div>
                                    <span>Winner</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="result-actions">
                        <button class="submit-results" onclick="submitGameResults()">Submit Results</button>
                        <button class="cancel-results" onclick="closeGameResultDialog()">Cancel</button>
                    </div>
                </div>
            `;

            dialog.dataset.courtIndex = courtIndex;
            dialog.style.display = 'block';
            overlay.style.display = 'block';
        }

        function toggleWinner(playerId) {
            const card = document.querySelector(`.player-result-card[data-player-id="${playerId}"]`);
            card.classList.toggle('selected');
        }

        function submitGameResults() {
            const dialog = document.getElementById('gameResultDialog');
            const courtIndex = parseInt(dialog.dataset.courtIndex);
            const court = courts[courtIndex];
            
            const winners = Array.from(document.querySelectorAll('.player-result-card.selected'))
                .map(card => card.dataset.playerId);

            if (winners.length === 0) {
                showToast('Please select at least one winner', 'error');
                return;
            }

            // Record game in history
            const gameEntry = {
                date: new Date(),
                courtNumber: courtIndex + 1,
                players: court.players.map(p => ({
                    name: p.name,
                    level: p.level,
                    winner: winners.includes(p.id)
                }))
            };
            gameHistory.push(gameEntry);

            // Update player stats
            court.players.forEach(player => {
                const p = players.find(p => p.id === player.id);
                if (p) {
                    p.gamesPlayed++;
                    if (winners.includes(player.id)) {
                        p.wins++;
                    } else {
                        p.losses++;
                    }
                }
            });

            // Clear just this court
            courts[courtIndex] = {
                players: [],
                startTime: null
            };
            
            // Close dialog
            dialog.style.display = 'none';
            document.getElementById('dialogOverlay').style.display = 'none';
            
            updateDisplay();
            showToast('Game results recorded successfully!');
        }

        function showGameHistory() {
            document.querySelector('.container').style.display = 'none';
            document.getElementById('gameHistory').style.display = 'block';
            
            // Update active state
            document.querySelectorAll('.bottom-nav button').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.bottom-nav button:nth-child(3)').classList.add('active');
            
            // Update history entries
            document.getElementById('historyEntries').innerHTML = 
                gameHistory.map((game, index) => `
                    <div class="history-entry">
                        <strong>Game ${index + 1}</strong> - 
                        Court ${game.courtNumber} - 
                        ${new Date(game.date).toLocaleString()}
                        <br>
                        Players: ${game.players.map(p => 
                            `${p.name} (Level ${p.level})`
                        ).join(', ')}
                    </div>
                `).join('');
        }

        function showCourts() {
            document.querySelector('.container').style.display = 'grid';
            document.querySelector('.player-pool').style.display = 'flex';
            document.getElementById('gameHistory').style.display = 'none';
            document.querySelector('.courts-container').style.display = 'block';
            
            // Update active state for mobile nav
            document.querySelectorAll('.bottom-nav button').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.bottom-nav button:nth-child(4)').classList.add('active');
            
            updateDisplay();
        }

        // Call showCourts on initial load
        window.addEventListener('load', () => {
            showCourts();
        });

        function createPlayerCard(player) {
            // Find if player is in an active game
            const isInGame = courts.some(court => 
                court.startTime && court.players.some(p => p.id === player.id)
            );

            // Calculate time since last game
            const lastGame = gameHistory
                .slice()
                .reverse()
                .find(game => game.players.some(p => p.name === player.name));
            
            const timeSinceLastGame = lastGame 
                ? Date.now() - new Date(lastGame.date).getTime()
                : null;

            // Determine player status
            let statusTag = '';
            if (isInGame) {
                statusTag = '<span class="status-tag in-game">In Game</span>';
            } else if (timeSinceLastGame && timeSinceLastGame < 10 * 60 * 1000) { // 10 minutes
                statusTag = '<span class="status-tag resting">Resting</span>';
            } else if (player.gamesPlayed === 0) {
                statusTag = '<span class="status-tag waiting">New Player</span>';
            } else if (timeSinceLastGame && timeSinceLastGame > 30 * 60 * 1000) { // 30 minutes
                statusTag = '<span class="status-tag inactive">Inactive</span>';
            }

            // Create game history dots
            const MAX_DOTS = 10; // Maximum dots to show before using +X format
            const gameDots = [];
            
            // Get last X games from history for this player
            const playerGames = gameHistory
                .slice()
                .reverse()
                .filter(game => game.players.some(p => p.name === player.name))
                .slice(0, MAX_DOTS);

            const dotsHtml = playerGames.length > 0 
                ? playerGames.map(game => {
                    const playerResult = game.players.find(p => p.name === player.name);
                    return `<div class="game-dot ${playerResult.winner ? 'win' : 'loss'}" 
                                title="${playerResult.winner ? 'Won' : 'Lost'} game on ${new Date(game.date).toLocaleDateString()}"></div>`;
                }).join('')
                : Array(Math.min(player.gamesPlayed, MAX_DOTS))
                    .fill(`<div class="game-dot"></div>`)
                    .join('');

            const remainingGames = player.gamesPlayed - MAX_DOTS;
            const overflowHtml = remainingGames > 0 
                ? `<span class="game-count-overflow">+${remainingGames}</span>` 
                : '';

            return `
                <div class="player-card ${isInGame ? 'in-game' : ''}" 
                     draggable="${!isInGame}"
                     ondragstart="drag(event)"
                     ondragend="dragEnd(event)"
                     id="player-${player.id}">
                    <div class="player-info" id="player-info-${player.id}">
                        <div class="player-name" onclick="${!isInGame ? `enableInlineEdit('${player.id}', 'name')` : ''}">
                            <span class="editable-text">${player.name}</span>
                            ${statusTag}
                            ${!isInGame ? '<span class="edit-hint">✎</span>' : ''}
                        </div>
                        <div class="player-level" onclick="${!isInGame ? `enableInlineEdit('${player.id}', 'level')` : ''}">
                            <span class="editable-text">Level ${player.level}</span>
                            ${!isInGame ? '<span class="edit-hint">✎</span>' : ''}
                        </div>
                        <div class="player-stats">
                            <div class="player-stats-text">
                                Games: ${player.gamesPlayed} | W/L: ${player.wins}/${player.losses}
                            </div>
                            <div class="game-dots">
                                ${dotsHtml}
                                ${overflowHtml}
                            </div>
                        </div>
                    </div>
                    <div class="player-edit-form" id="player-edit-${player.id}" style="display: none;">
                        <input type="text" 
                               class="inline-edit-name" 
                               value="${player.name}"
                               onkeydown="handleInlineEditKeydown(event, '${player.id}')"
                               data-original="${player.name}">
                        <select class="inline-edit-level" 
                                onchange="updatePlayerInline('${player.id}')"
                                data-original="${player.level}">
                            <option value="1" ${player.level === 1 ? 'selected' : ''}>Level 1 - Beginner</option>
                            <option value="2" ${player.level === 2 ? 'selected' : ''}>Level 2 - Intermediate</option>
                            <option value="3" ${player.level === 3 ? 'selected' : ''}>Level 3 - Advanced</option>
                            <option value="4" ${player.level === 4 ? 'selected' : ''}>Level 4 - Expert</option>
                            <option value="5" ${player.level === 5 ? 'selected' : ''}>Level 5 - Pro</option>
                        </select>
                        <div class="inline-edit-actions">
                            <button onclick="updatePlayerInline('${player.id}')" class="save-btn">Save</button>
                            <button onclick="cancelInlineEdit('${player.id}')" class="cancel-btn">Cancel</button>
                        </div>
                    </div>
                    ${!isInGame ? `
                        <button class="delete-btn" onclick="event.preventDefault(); deletePlayer('${player.id}')">
                            <span class="delete-icon">×</span>
                        </button>
                    ` : ''}
                </div>
            `;
        }

        let selectedLevel = null;

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function selectLevel(level) {
            selectedLevel = level;
            document.querySelectorAll('.level-chip').forEach(chip => {
                chip.classList.remove('selected');
            });
            document.querySelector(`.level-chip[data-level="${level}"]`).classList.add('selected');
        }

        function showAddPlayerDialog() {
            document.getElementById('addPlayerDialog').style.display = 'block';
            document.getElementById('dialogOverlay').style.display = 'block';
            document.getElementById('newPlayerName').focus();
            selectedLevel = null;
            document.querySelectorAll('.level-chip').forEach(chip => {
                chip.classList.remove('selected');
            });
            updateLevelCounts();
        }

        function closeAddPlayerDialog() {
            document.getElementById('addPlayerDialog').style.display = 'none';
            document.getElementById('dialogOverlay').style.display = 'none';
            document.getElementById('newPlayerName').value = '';
            selectedLevel = null;
        }

        function handleAddPlayer(event) {
            event.preventDefault();
            
            const name = document.getElementById('newPlayerName').value.trim();
            
            if (!name) {
                showToast('Please enter a player name', 'error');
                return;
            }
            
            if (!selectedLevel) {
                showToast('Please select a skill level', 'error');
                return;
            }

            // Check for duplicate names
            if (players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                showToast('A player with this name already exists', 'error');
                return;
            }

            players.push({
                id: Date.now().toString(),
                name: name,
                level: selectedLevel,
                gamesPlayed: 0,
                wins: 0,
                losses: 0
            });

            showToast(`Added ${name} successfully!`);
            closeAddPlayerDialog();
            updateDisplay();
        }

        // Replace existing addNewPlayer function with:
        function addNewPlayer() {
            showAddPlayerDialog();
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Don't trigger shortcuts if in an input field
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            if (e.key === 'a' || e.key === 'A') {
                e.preventDefault();
                addNewPlayer();
            } else if (e.key === 'h' || e.key === 'H') {
                e.preventDefault();
                showGameHistory();
            } else if (e.key === 'Escape') {
                closeAddPlayerDialog();
                closeEditDialog();
                document.getElementById('gameResultDialog').style.display = 'none';
                document.getElementById('dialogOverlay').style.display = 'none';
            }
        });

        let editingPlayerId = null;

        function editPlayer(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            editingPlayerId = playerId;
            document.getElementById('editPlayerName').value = player.name;
            document.getElementById('editPlayerLevel').value = player.level;
            document.getElementById('editPlayerDialog').style.display = 'block';
            document.getElementById('dialogOverlay').style.display = 'block';
        }

        function closeEditDialog() {
            editingPlayerId = null;
            document.getElementById('editPlayerDialog').style.display = 'none';
            document.getElementById('dialogOverlay').style.display = 'none';
        }

        function savePlayerEdit() {
            if (!editingPlayerId) return;

            const name = document.getElementById('editPlayerName').value;
            const level = parseInt(document.getElementById('editPlayerLevel').value);

            if (!name || isNaN(level)) {
                alert('Please fill in all fields correctly');
                return;
            }

            const player = players.find(p => p.id === editingPlayerId);
            if (player) {
                player.name = name;
                player.level = level;
            }

            closeEditDialog();
            updateDisplay();
        }

        function deletePlayer(playerId) {
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            if (!confirm(`Are you sure you want to remove ${player.name}?`)) return;

            const playerIndex = players.findIndex(p => p.id === playerId);
            if (playerIndex > -1) {
                players.splice(playerIndex, 1);
                showToast(`Removed ${player.name}`);
                updateDisplay();
            }
        }

        // Add local storage support
        function saveState() {
            localStorage.setItem('queueMasterState', JSON.stringify({
                players,
                courts,
                gameHistory
            }));
        }

        function loadState() {
            const saved = localStorage.getItem('queueMasterState');
            if (saved) {
                const state = JSON.parse(saved);
                players = state.players || [];
                courts = state.courts || [];
                gameHistory = state.gameHistory || [];
                updateDisplay();
            }
        }

        // Save state after each change
        const originalUpdateDisplay = updateDisplay;
        updateDisplay = function() {
            originalUpdateDisplay();
            saveState();
        };

        // Initialize the app
        loadState();
        initializeCourts();

        function enableInlineEdit(playerId, field) {
            const infoElement = document.getElementById(`player-info-${playerId}`);
            const editElement = document.getElementById(`player-edit-${playerId}`);
            
            infoElement.style.display = 'none';
            editElement.style.display = 'block';
            
            const inputElement = editElement.querySelector(field === 'name' ? '.inline-edit-name' : '.inline-edit-level');
            inputElement.focus();
        }

        function handleInlineEditKeydown(event, playerId) {
            if (event.key === 'Enter') {
                updatePlayerInline(playerId);
            } else if (event.key === 'Escape') {
                cancelInlineEdit(playerId);
            }
        }

        function updatePlayerInline(playerId) {
            const editElement = document.getElementById(`player-edit-${playerId}`);
            const nameInput = editElement.querySelector('.inline-edit-name');
            const levelSelect = editElement.querySelector('.inline-edit-level');
            
            const newName = nameInput.value.trim();
            const newLevel = parseInt(levelSelect.value);
            
            if (!newName) {
                showToast('Name cannot be empty', 'error');
                return;
            }

            const player = players.find(p => p.id === playerId);
            if (player) {
                player.name = newName;
                player.level = newLevel;
                showToast('Player updated successfully');
            }

            cancelInlineEdit(playerId);
            updateDisplay();
        }

        function cancelInlineEdit(playerId) {
            const infoElement = document.getElementById(`player-info-${playerId}`);
            const editElement = document.getElementById(`player-edit-${playerId}`);
            
            infoElement.style.display = 'block';
            editElement.style.display = 'none';
        }

        let currentCourtIndex = null;

        function showPlayerSearch(courtIndex) {
            currentCourtIndex = courtIndex;
            document.getElementById('playerSearchModal').style.display = 'block';
            document.getElementById('dialogOverlay').style.display = 'block';
            document.getElementById('courtPlayerSearch').value = '';
            document.getElementById('courtPlayerSearch').focus();
            searchCourtPlayers();
        }

        function closePlayerSearch() {
            document.getElementById('playerSearchModal').style.display = 'none';
            document.getElementById('dialogOverlay').style.display = 'none';
            currentCourtIndex = null;
        }

        function searchCourtPlayers() {
            const searchTerm = document.getElementById('courtPlayerSearch').value.toLowerCase();
            const availablePlayers = players.filter(p => 
                !courts.some(court => court.players.some(cp => cp.id === p.id)) &&
                p.name.toLowerCase().includes(searchTerm)
            );

            document.getElementById('playerSearchResults').innerHTML = 
                availablePlayers.map(player => `
                    <div class="search-result-item" onclick="addPlayerToCourt('${player.id}')">
                        <strong>${player.name}</strong> (Level ${player.level})
                        <div class="player-stats">
                            Games: ${player.gamesPlayed} | W/L: ${player.wins}/${player.losses}
                        </div>
                    </div>
                `).join('') || '<p>No available players found</p>';
        }

        function addPlayerToCourt(playerId) {
            if (currentCourtIndex === null) return;
            
            const player = players.find(p => p.id === playerId);
            const court = courts[currentCourtIndex];
            
            if (player && court && court.players.length < 4) {
                court.players.push(player);
                showToast(`Added ${player.name} to Court ${currentCourtIndex + 1}`);
                closePlayerSearch();
                updateDisplay();
            } else {
                showToast('Cannot add player to court', 'error');
            }
        }

        function showBulkAddDialog() {
            document.getElementById('bulkAddDialog').style.display = 'block';
            document.getElementById('dialogOverlay').style.display = 'block';
            document.getElementById('bulkPlayerNames').focus();
        }

        function closeBulkAddDialog() {
            document.getElementById('bulkAddDialog').style.display = 'none';
            document.getElementById('dialogOverlay').style.display = 'none';
            document.getElementById('bulkPlayerNames').value = '';
        }

        function handleBulkAddPlayers(event) {
            event.preventDefault();
            
            const namesText = document.getElementById('bulkPlayerNames').value.trim();
            const defaultLevel = parseInt(document.getElementById('bulkPlayerLevel').value);
            
            if (!namesText) {
                showToast('Please enter player names', 'error');
                return;
            }

            const names = namesText.split('\n')
                .map(name => name.trim())
                .filter(name => name.length > 0);

            // Check for duplicates in the input
            const uniqueNames = new Set(names);
            if (uniqueNames.size !== names.length) {
                showToast('Duplicate names found in input', 'error');
                return;
            }

            // Check for existing names
            const existingNames = new Set(players.map(p => p.name.toLowerCase()));
            const duplicates = names.filter(name => 
                existingNames.has(name.toLowerCase())
            );

            if (duplicates.length > 0) {
                showToast(`Some players already exist: ${duplicates.join(', ')}`, 'error');
                return;
            }

            // Add all players
            names.forEach(name => {
                players.push({
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    name: name,
                    level: defaultLevel,
                    gamesPlayed: 0,
                    wins: 0,
                    losses: 0
                });
            });

            showToast(`Added ${names.length} players successfully!`);
            closeBulkAddDialog();
            updateDisplay();
        }

        // Add event listeners for filters
        document.addEventListener('DOMContentLoaded', () => {
            ['statusFilters', 'levelFilters', 'sortFilters'].forEach(id => {
                document.getElementById(id).addEventListener('click', handleFilterClick);
            });
        });

        // Add this function to update level counts
        function updateLevelCounts() {
            const levelCounts = players.reduce((counts, player) => {
                counts[player.level] = (counts[player.level] || 0) + 1;
                return counts;
            }, {});

            document.querySelectorAll('.level-chip').forEach(chip => {
                const level = parseInt(chip.dataset.level);
                const count = levelCounts[level] || 0;
                chip.querySelector('.level-count').textContent = count;
            });
        }

        function showConfirmDialog() {
            document.getElementById('confirmDialog').style.display = 'block';
        }

        function closeConfirmDialog() {
            document.getElementById('confirmDialog').style.display = 'none';
        }

        function clearAllData() {
            // Clear all data structures
            players = [];
            gameHistory = [];
            courts = Array(COURTS_COUNT).fill().map(() => ({
                players: [],
                startTime: null
            }));

            // Clear localStorage
            localStorage.removeItem('queueMasterState');

            // Update display
            updateDisplay();
            closeClearDataDialog();
            showToast('All data has been cleared');

            // Return to courts view
            showCourts();
        }

        function showClearDataConfirmation() {
            document.getElementById('clearDataDialog').style.display = 'block';
            document.getElementById('dialogOverlay').style.display = 'block';
        }

        function closeClearDataDialog() {
            document.getElementById('clearDataDialog').style.display = 'none';
            document.getElementById('dialogOverlay').style.display = 'none';
        }
    </script>
</body>
</html>